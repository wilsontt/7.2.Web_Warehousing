# 實作計畫 (PLAN): 1.1 代碼維護 (Code Maintenance)

**文件版本**: v1.0.0
**狀態**: 審核中 (Under Review)
**負責人**: AI 專案顧問
**依據規格**: `1.specs/1.基本作業/1.1.代碼維護.spec.md` (v1.2.0)
**最後更新**: 2026-01-01

---

## 1. 憲章遵循檢查 (Constitution Check)

本計畫已依據 `1.專案憲章 Project Constitution.md` (v2.3.1) 進行自我檢查：

- [x] **P0 規格驅動**: 依據 Phase 1 產出的 `spec.md` 制定。
- [x] **P1 簡潔優先**: 採用統一的 `ResizableLayout` 與三欄式設計，不引入額外複雜度。
- [x] **P2 設計即安全**: 
    - 採用批次儲存 (Explicit Save)，防止誤操作。
    - 前端驗證規則與後端一致。
- [x] **P3 可測試性**: 
    - 定義明確的 UI 測試步驟。
    - 使用 Mock Service 隔離後端依賴，確保前端邏輯可測試。
- [x] **P5 正體中文**: 文件與 UI 介面全數使用 zh-TW。
- [x] **P8 使用者體驗**:
    - 支援深/淺色模式 (Dark/Light Mode)。
    - 使用 `ResizableLayout` 標準版型。
    - 符合 DataTable 互動規範 (Hover, Selected)。
- [x] **P11 技術堆疊**: 使用 React 18 + TypeScript + Tailwind CSS。

---

## 2. 系統架構與設計 (Architecture & Design)

### 2.1 前端架構 (Frontend)

*   **路徑 (Route)**: `/basic/code-maintenance` (對應「1.基本作業」)
*   **版型 (Layout)**: `ResizableLayout` (左側 25%, 右側上下分割)
    *   由於是三層式結構，將擴充標準 Layout 或使用 Nested Grid 實作右側的上下分割。
*   **狀態管理 (State Management)**: 
    *   使用 `React.useState` 管理 UI 狀態 (Selection, Loading)。
    *   使用 `Dirty Tracking` 機制追蹤未儲存變更 (Add/Update/Delete)。
*   **API 服務 (Service)**:
    *   `CodeMaintenanceService`: 封裝所有 API 呼叫。
    *   **Mock Mode**: 在無後端情況下，使用 `utils/mockAdapter` 攔截請求並回傳記憶體中的數據。

### 2.2 元件設計 (Components)

| 元件名稱 | 職責 | 對應 Spec |
| :--- | :--- | :--- |
| `CodeMaintenancePage` | 頁面容器 (Container)。管理三層資料狀態、選取狀態、髒檢查 (Dirty Check) 與批次儲存邏輯。 | 5.1 |
| `MajorCategoryList` | 顯示大分類列表 (CDF)。支援單選、新增、刪除。 | 3.2.1 |
| `MidCategoryList` | 顯示中分類列表 (CDS)。根據大分類篩選。 | 3.2.2 |
| `SubCategoryList` | 顯示細分類列表 (CDT)。根據中分類篩選。 | 3.2.3 |
| `CategoryForm` | (Optional) 共用的編輯表單元件，或直接做在列表的 Inline Edit。**本計畫採 Inline Edit (行內編輯) 搭配底部狀態列** 以符合高效率維護需求。 | US-1.1-001 |

### 2.3 資料流與批次儲存機制

1.  **讀取**: 頁面載入時呼叫 `getAllCoordinates()` 取得完整三層結構 (考量資料量小，一次載入效能可接受)。
2.  **變更緩存 (Change Buffer)**:
    *   建立 `changes` 物件：`{ cdf: { inserts: [], updates: [], deletes: [] }, cds: {...}, cdt: {...} }`
    *   使用者操作 (CUD) 不會直接打 API，而是更新 UI List 並寫入 `changes`。
3.  **儲存 (Commit)**:
    *   使用者點擊「儲存」。
    *   Service 打包 `changes` 送出 `POST /api/codemaintenance/batch`。
    *   成功後清空 `changes` 並重新 `getAllCoordinates()` (或直接更新本地 Cache)。

---

## 3. 執行任務 (Execution Tasks)

### 3.1 基礎建設 (Infrastructure)
- [ ] **T-1-1-1**: 定義 TypeScript Interfaces (`types/codeMaintenance.ts`)
    - 含 `MajorCategory`, `MidCategory`, `SubCategory` 及 `BatchSaveRequest`。
    - 確保欄位名稱符合 Lovable 規範 (e.g. `CategoryFirstNo`).
- [ ] **T-1-1-2**: 建立 Mock Service (`services/codeMaintenanceService.ts`)
    - 實作 `getAllCoordinates` (回傳假資料)。
    - 實作 `saveBatch` (Console log 並模擬延遲)。

### 3.2 UI 元件開發 (UI Implementation)
- [ ] **T-1-1-3**: 建立頁面骨架 (`pages/basic/CodeMaintenancePage.tsx`)
    - 設定 Route (`App.tsx`)。
    - 實作三欄式 Grid 佈局。
    - 實作 Toolbar (新增/儲存/取消按鈕)。
- [ ] **T-1-1-4**: 實作大分類列表 (`MajorCategoryList`)
    - 支援 `DataTable` 規範 (Hover, Selected, Sticky Header)。
    - 實作點擊篩選邏輯。
- [ ] **T-1-1-5**: 實作中/細分類列表 (`MidCategoryList`, `SubCategoryList`)
    - 實作連動邏輯 (Parent 改變時清空/重載)。
    - 實作 Empty State (未選父層時的提示)。

### 3.3 邏輯實作 (Logic Implementation)
- [ ] **T-1-1-6**: 實作 CRUD 狀態管理
    - 新增：前端產生臨時 ID，標記為 `isNew`。
    - 修改：標記為 `isDirty`。
    - 刪除：視覺隱藏，加入 `deletes` 佇列。
    - 驗證：防呆檢查 (刪除父層前檢查子層)。
- [ ] **T-1-1-7**: 整合批次儲存
    - 串接 Service `saveBatch`。
    - 處理 Loading 狀態與錯誤提示 (Toast)。

---

## 4. 驗證計畫 (Verification Plan)

### 4.1 自動化測試 (Automated Tests)
*   暫無 (Phase 1 專注於 UI 互動與 Mock 驗證)。

### 4.2 手動驗證項目 (Manual Verification)
1.  **佈局檢查**:
    *   [ ] 確認三欄寬度比例符合 25% : 35% : 40%。
    *   [ ] 縮放視窗時 RWD 行為正常。
2.  **各層級 CRUD**:
    *   [ ] 新增一層、二層、三層資料，確認 Parent ID 自動帶入。
    *   [ ] 修改資料，確認 Dirty 標記 (儲存按鈕亮起)。
    *   [ ] 刪除含子層的父層，確認被阻擋 (Alert)。
3.  **主題測試**:
    *   [ ] 切換深色模式，確認表格背景、文字顏色、Border 顏色正確反轉。
4.  **批次儲存**:
    *   [ ] 多次操作後一次儲存，檢查 Console 的 Payload 結構是否正確。

---

## 5. 風險評估 (Risk Assessment)

- **資料量風險**: 若細分類 (CDT) 資料量過大 (>1000筆)，一次載入可能會卡頓。
    - **對策**: 目前假設代碼檔資料量小。若未來變大，需改為 Lazy Loading (點擊中分類才載入細分類)。
- **併發風險**: 多人同時維護同一代碼。
    - **對策**: 透過 `LockVer` (樂觀鎖) 機制，後端 API 需處理版本衝突回傳錯誤。

---
**附註**: 本計畫經核准後，將據此建立 `tasks.md` 並開始 Phase 4 執行。
