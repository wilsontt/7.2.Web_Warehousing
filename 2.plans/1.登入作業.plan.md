# 計畫文件 (PLAN): 登入作業 (Login Operations)

**文件版本**: v1.0.0
**狀態**: 草稿 (Draft)
**建立日期**: 2025-11-27
**依據**: `1.specs/1.登入作業.spec.md`

---

## 1. 憲章遵循檢查 (Constitution Check)

| 原則 | 檢查項目 | 符合 | 說明 |
| :--- | :--- | :---: | :--- |
| **P0: SDD 流程** | 是否有對應的 Spec 文件？ | ✅ | 已建立 `1.specs/1.登入作業.spec.md` |
| **P1: 簡潔優先** | 是否避免過度設計？ | ✅ | 使用 React Context + localStorage 實作輕量級認證，符合現階段需求。 |
| **P2: 設計即安全** | 是否考量安全性？ | ✅ | 實作 6 次錯誤鎖定機制；密碼欄位預設遮蔽。 |
| **P3: 清晰可測** | 是否可測試？ | ✅ | 邏輯分離於 Context 與 Hook，易於單元測試。 |
| **P5: 正體中文** | 是否使用正體中文？ | ✅ | 所有 UI 提示與文件皆使用正體中文。 |
| **P8: 一致體驗** | 是否符合設計規範？ | ✅ | 使用 Crown Logo 與 Tailwind CSS 系統樣式。 |

---

## 2. 技術架構 (Technical Architecture)

### 2.1 前端技術堆疊
- **框架**: React 18 + TypeScript
- **樣式**: Tailwind CSS
- **表單處理**: React Hook Form + Zod (Schema Validation)
- **圖示庫**: Lucide React
- **路由**: React Router v6
- **狀態管理**: React Context API (AuthContext)

### 2.2 資料流
1.  使用者在 `Login.tsx` 輸入帳密。
2.  `LoginForm` 透過 Zod 驗證格式。
3.  驗證通過後，呼叫 `AuthContext.login(username, password)`。
4.  `AuthContext` 檢查帳密（目前為 Mock：admin/admin123）與鎖定狀態。
5.  若成功：更新 `isAuthenticated` 狀態，寫入 localStorage，導向 `/` (Dashboard)。
6.  若失敗：增加錯誤計數，回傳錯誤訊息；若達 6 次則觸發鎖定。

---

## 3. 檔案變更 (File Changes)

### [NEW] src/contexts/auth-context.tsx
- **目的**: 管理全域登入狀態、錯誤計數與鎖定邏輯。
- **主要功能**:
    - `login(username, password)`
    - `logout()`
    - `isAuthenticated` (boolean)
    - `isLocked` (boolean)
    - `errorCount` (number)

### [NEW] src/components/auth/protected-route.tsx
- **目的**: 路由守衛，保護需要登入才能存取的頁面。
- **邏輯**: 若 `!isAuthenticated`，則 `<Navigate to="/login" />`。

### [NEW] src/pages/Login.tsx
- **目的**: 登入頁面 UI。
- **內容**:
    - 包含 Crown Logo。
    - 整合 `LoginForm` 組件。
    - 處理鎖定狀態的 Alert Dialog。

### [MODIFY] src/App.tsx
- **目的**: 設定路由。
- **變更**:
    - 新增 `/login` 路由。
    - 將 `/` (Dashboard) 包裹在 `<ProtectedRoute>` 中。
    - 整合 `<AuthProvider>`。

### [MODIFY] src/components/layout/Header.tsx (或對應檔案)
- **目的**: 新增登出按鈕。
- **變更**: 在使用者選單中加入「登出」選項，呼叫 `logout()`。

---

## 4. 驗證計畫 (Verification Plan)

### 4.1 自動化測試 (Automated Tests)
*   **單元測試 (Unit Tests)**:
    *   測試 `auth-context` 的邏輯：
        *   輸入正確帳密應回傳成功。
        *   輸入錯誤帳密應增加錯誤計數。
        *   錯誤達 6 次應鎖定帳號。
        *   鎖定後即使輸入正確帳密也應失敗。

### 4.2 手動驗證 (Manual Verification)
1.  **正常登入流程**:
    *   進入 `/login`。
    *   輸入 `admin` / `admin123`。
    *   確認成功導向至 Dashboard。
2.  **密碼顯示切換**:
    *   輸入密碼，點擊眼睛圖示，確認可切換明碼/隱碼。
3.  **錯誤處理驗證**:
    *   輸入錯誤密碼，確認顯示錯誤訊息與次數。
4.  **鎖定機制驗證**:
    *   連續輸入錯誤 6 次。
    *   確認跳出「帳號已被鎖定」警告框。
    *   確認無法再進行登入嘗試。
5.  **路由保護驗證**:
    *   在未登入狀態下，直接輸入 Dashboard 網址，確認被導回 `/login`。
6.  **登出驗證**:
    *   登入後，點擊登出，確認回到登入頁，且無法按「上一頁」回到 Dashboard。
