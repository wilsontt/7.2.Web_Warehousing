# 規格驅動開發 (SDD) 工作流程
# 暨 核心文件範本 (Templates)

**文件版本**: v1.1.0  
**流程制定者**: 專案顧問 (Gemini)  
**依據憲章**: `1.專案憲章 Project Constitution.md`  
**最近修訂**: 2025-11-28 (新增：前後端欄位映射規範)

## 流程總覽 (Process Overview)

本流程旨在將「文件倉儲管理系統 2.0」的開發工作，依據「專案憲章」拆分為數個獨立的「模組開發迭代 (Module Iteration)」。

在 `0.standards/0.專案憲章-總規範-SDD工作流程/2.文件倉儲管理系統 Warehouse Management System 設計規範v2.0.md` 中定義的 8 個主要功能選單（如：「1.基本作業」、「2.例行作業」等），將被視為 8 個獨立的「有界上下文 (Bounded Context)」，並成為 8 次主要的開發迭代。

### 檔案目錄結構規範（新增 2025/11/28）
為確保專案結構的一致性，所有產出文件必須依據 **8大核心功能** 分類存放：

- `1.specs/`, `2.plans/`, `3.tasks/`, `4.reviews/` 四個目錄下，皆須包含以下子目錄：
  1. `1.基本作業/`
  2. `2.例行作業/`
  3. `3.庫存作業/`
  4. `4.客戶作業/`
  5. `5.移儲作業/`
  6. `6.稽核作業/`
  7. `7.倉儲管理作業/`
  8. `8.系統管理作業/`
- **規則**：所有模組的 spec, plan, tasks, review 文件，**必須** 存放於對應功能的子目錄中，不得直接置於根目錄（共用或特殊模組除外，如：登入作業）。

每一次迭代都必須嚴格遵循以下五個階段：

1.  **Phase 1: 規格 (SPEC)** - `[功能目錄]/[模組名稱].spec.md`
2.  **Phase 2: 計畫 (PLAN)** - `[功能目錄]/[模組名稱].plan.md`
3.  **Phase 3: 任務 (Tasks)** - `[功能目錄]/[模組名稱].Tasks.md`
4.  **Phase 4: 執行 (EXECUTE)** - ( implement & Code) 
5.  **Phase 5: 驗收 (REVIEW)** - `[功能目錄]/[模組名稱].REVIEW.md`

---

### 主題一致性稽核（新增 2025/11/16）
- 在 Phase 4 每個畫面完成後，必須執行「深/淺色主題一致性檢查」：
  - 範圍：頂部導覽列、主選單與其下拉面板、主要內容區、表格/分頁、對話框與彈出式面板。
  - 驗收：切換主題時，上述區塊的背景、字色、邊框、hover/selected/focus/disabled 狀態均正確套用 `dark:` 對應，對比度達 WCAG AA。
- 在 Phase 5 驗收中加入「主題切換 E2E 測試」與「DataTable 分頁資訊 full/compact/auto 模式」視覺一致性檢查。

## Phase 1: 規格 (SPEC) - 定義「做什麼」

**目標**: 產出一份清晰、可測試、無歧義的「產品需求文件 (PRD)」。
**產出**: `[模組名稱].spec.md`

> **顧問註記**: 這是專案的「需求基石」。這份文件將凍結(Sign-off)該模組的範疇 (Scope)。

### `[模組名稱].spec.md` 範本

```markdown
# 規格文件 (SPEC): [模組名稱，例如：1. 基本作業]
**版本**: 1.0
**狀態**: [草稿 | 審核中 | 已核准]
**負責人**: [產品經理或您]

## 1. 模組概述 (Overview)
(描述此模組的核心目的。例如：本模組負責管理系統運作所需的所有基礎資料，包含客戶、倉庫、車輛等。)

## 2. 功能清單與使用者故事 (Features & User Stories)
(此處應將 `0.1.主選單功能清單.md` 的舊功能，轉化為新系統的故事)

### 2.1 [功能子項，例如：客戶基本資料維護]
**使用者故事 (User Story)**:
- **身為** [角色，例如：系統管理員]
- **我想要** [操作，例如：新增、修改、查詢客戶基本資料]
- **以便** [目的，例如：讓系統能正確識別客戶身份與收費標準]

**驗收條件 (Acceptance Criteria) - [憲章 P3, P7]**:
- [ ] **(驗證規則)** 必須符合 `standards/2.文件倉儲管理系統 Warehouse Management System 設計規範v2.0.md` 中的所有驗證規則（例如 EMAIL 格式、必填欄位）。
- [ ] **(UI 規範)** 介面必須採用 `standards/2.文件倉儲管理系統 Warehouse Management System 設計規範v2.0.md` 定義的 Master-Detail 佈局 與 ResizableLayout。
- [ ] **(功能)** 按下「停用」按鈕時，該客戶資料應被標記為停用，但不應從資料庫刪除。
- [ ] **(安全)** 只有具備「客戶維護」權限的角色才能看到「新增」、「修改」按鈕。

### 2.2 [下一個功能子項...]

## 3. 資料模型與欄位映射規範 (Data Model & Field Mapping)

### 3.1 資料表關聯結構
(描述 ERD 或 Master-Detail 關係，可使用 Mermaid 圖表)

### 3.2 前後端欄位映射與行為規範 ⭐

> **[重要安全設計]** 依據 **P2 設計即安全** 原則：
> - 前端**禁止**直接使用資料庫欄位名稱（如 `TBL_FIELD_01`）。
> - 所有欄位必須使用「英文欄名 (Lovable)」進行映射（如 `CustomerName`）。
> - 前端元件行為、預設值與唯讀狀態**必須**遵循資料表定義文件的配置。
> - **資料驅動 UI**：前端應從後端 API 取得欄位 Metadata，動態產生表單與驗證規則。

#### 3.2.1 欄位映射表格式規範 📋

每個涉及資料庫的 SPEC 文件，**必須**包含以下格式的欄位映射表：

| 資料庫欄位 | 前端欄位名稱 (Lovable) | 中文名稱 | 必填 | 唯一 | 顯示格式/驗證規則 | 新增預設值 | 編輯狀態 (新/修) |
|:---|:---|:---|:---:|:---:|:---|:---|:---:|
| `DB_FIELD_NAME` | `FrontendFieldName` | 欄位中文名 | ✅/❌ | ✅/❌ | 格式規則 | 預設值 | ✅/❌ / ✅/❌ |

**欄位說明**：
- **資料庫欄位**: 實際資料表的欄位名稱（僅用於後端映射，前端不可見）
- **前端欄位名稱 (Lovable)**: 前端使用的語意化名稱（符合 PascalCase 或 camelCase 命名規範）
- **中文名稱**: UI 顯示的欄位標籤
- **必填**: 是否為必填欄位（✅ = 必填, ❌ = 非必填）
- **唯一**: 是否需唯一性驗證（✅ = 唯一, ❌ = 可重複）
- **顯示格式/驗證規則**: 如千分位、日期格式 `yyyy/MM/dd`、正則表達式等
- **新增預設值**: 新增時的預設值（如 `Current User`, `Current Time`, `0`, `Empty`, `-`）
- **編輯狀態 (新/修)**: 分別標記「新增模式」和「修改模式」下該欄位是否可編輯
  - 格式：`✅ / ✅` 表示「新增可編輯 / 修改可編輯」
  - 範例：`✅ / ❌` 表示「新增可編輯 / 修改不可編輯（主鍵保護）」

#### 3.2.2 系統欄位標準化規範 🔧

所有資料表**應**包含以下標準系統欄位（稽核追蹤用）：

| 資料庫欄位 | 前端欄位名稱 | 用途 | 新增預設值 | 編輯狀態 | 顯示格式 |
|:---|:---|:---|:---|:---:|:---|
| `CRE_USERID` | `CreatedUserId` | 建檔人員ID | `APP_CURRENT_USER` | ❌ / ❌ | 顯示使用者名稱 |
| `CRE_DTIME` | `CreatedDateTime` | 建檔日期時間 | `APP_CURRENT_DATETIME_YYYYMMDDHHNNSS` | ❌ / ❌ | `yyyy/MM/dd HH:mm:ss` |
| `UPD_USERID` | `UpdatedUserId` | 修改人員ID | - | ❌ / ❌ | 顯示使用者名稱 (系統自動更新) |
| `UPD_DTIME` | `UpdatedDateTime` | 修改日期時間 | - | ❌ / ❌ | `yyyy/MM/dd HH:mm:ss` (系統自動更新) |
| `id` | `Id` | 主鍵序號 | Auto Increment | ❌ / ❌ | Hidden (不顯示於UI) |
| `lock_version` | `LockVersion` | 樂觀鎖版本 | 0 | ❌ / ❌ | Hidden (系統自動維護) |

**說明**：
- 這些欄位在**新增與修改模式下均為唯讀**，由系統自動填入。
- `CRE_*` 欄位在資料建立時填入，之後不可變更。
- `UPD_*` 欄位在每次修改時自動更新。
- `lock_version` 用於樂觀鎖機制（Optimistic Locking），防止併發修改衝突。

#### 3.2.3 日期時間格式標準 📅

**全專案統一規範**：

| 項目 | 格式 | 範例 | 說明 |
|:---|:---|:---|:---|
| **儲存格式** | `yyyyMMddHHmmss` | `20251128170500` | 14位數字字串（資料庫儲存） |
| **顯示格式** | `yyyy/MM/dd HH:mm:ss` | `2025/11/28 17:05:00` | UI 顯示格式 |
| **時區** | UTC+8 (Asia/Taipei) | - | 固定使用台灣時區 |

**轉換範例**：
```javascript
// 儲存時：前端送出
const storedValue = "20251128170500";

// 顯示時：前端格式化
const displayValue = formatDateTime(storedValue); // "2025/11/28 17:05:00"
```

#### 3.2.4 預設值常數規範 🔑

前端程式碼中使用的預設值常數**必須**使用全大寫命名（表示為系統常數）：

| 常數名稱 | 對應前端邏輯 | 後端處理 |
|:---|:---|:---|
| `APP_CURRENT_USER` | 取得當前登入使用者ID | 後端從 Token 解析 |
| `APP_CURRENT_DATETIME_YYYYMMDDHHNNSS` | 取得當前日期時間（儲存格式） | 後端使用伺服器時間 |
| `AUTO_INCREMENT` | 資料庫自動遞增 | 由資料庫產生 |
| `EMPTY` | 空字串 `""` | 前端預填 `""` |
| `0` | 數值零 | 前端預填 `0` |

**重要**：這些常數僅為「標記 (Marker)」，實際值由後端在儲存時填入，前端僅用於暫時顯示。

#### 3.2.5 數值欄位顯示規範 💰

數值欄位若需要格式化顯示，**必須**在「顯示格式/驗證規則」欄明確註記：

| 格式要求 | 說明 | 前端實作 | 範例 |
|:---|:---|:---|:---|
| **千分位** | 使用千分位符號 `,` | `toLocaleString('zh-TW')` | `1,234` |
| **2位小數** | 固定顯示兩位小數 | `toFixed(2)` | `1,234.56` |
| **右靠** | 數字靠右對齊 | CSS: `text-align: right` | - |
| **範圍限制** | `>= 0` 或其他條件 | 前端驗證 + 後端檢查 | 必須 >= 0 |

**完整範例**：
```
顯示格式/驗證規則: 千分位, 2位小數, 右靠, >= 0
```

#### 3.2.6 主鍵保護規範 🔒

**複合主鍵 (Composite Primary Key)** 在修改模式下必須保護：

```markdown
**範例**：
- 大分類編碼 (`CategoryFirstNo`): ✅ / ❌ (新增可輸入，修改不可改)
- 中分類編碼 (`CategorySecondNo`): ✅ / ❌ (新增可輸入，修改不可改)
```

**前端實作**：
- 新增模式：`<input type="text">`
- 修改模式：`<input type="text" disabled>` 或純文字顯示

## 4. 非功能性需求 (Non-Functional Requirements)
- **效能 (憲章 P9)**: 左側客戶列表的搜尋回應時間不得超過 2 秒。
- **安全 (憲章 P2, P5)**: 所有對客戶資料的 CUD (Create/Update/Delete) 操作，皆須產生稽核日誌。
- **語言 (憲章 P5)**: 所有介面文字、錯誤訊息**必須**提供正體中文（zh-TW）。

## 4. 模組依賴性 (Dependencies)
(描述此模組需要依賴哪些其他模組的資料)
- 例如：`客戶使用者維護` 功能依賴 `權限維護` 模組產出的「使用者群組」。
