# 0.1. 帳號整合與識別策略討論歷程

**文件版本**: v1.3.0
**建立日期**: 2025-11-29
**最近修訂**: 2025-11-30
**目的**: 記錄 Windows AD 整合、舊系統帳號相容性及識別碼設計的決策演進過程。

---

## 階段一：需求提出與核心挑戰

**時間點**: 專案初期架構分析
**關鍵議題**:
1.  **Single Sign-On (SSO)**: 希望導入 Windows AD 讓使用者單一登入。
2.  **歷史資料相容**: 舊系統的所有交易紀錄皆綁定舊 `USERID` (如 `001`)，必須保留且能查詢。
3.  **新舊並存**: 新系統需同時支援 AD 帳號 (如 `wilson.t`) 與舊 ID 的對應。

**初步討論方案與優缺點評估**:

在此階段，我們討論了三種可能的整合模式：

### 方案 A：建立獨立對照表 (UserMapping Table)
建立一張額外的表 (e.g., `AD_Legacy_Map`) 來串聯 AD 帳號與舊 ID。
- **優點**:
    - 資料庫正規化程度高，不污染新使用者主檔的結構。
    - 職責分離清楚。
- **缺點**:
    - **查詢效能損耗**: 每次登入或查詢使用者資訊皆需額外 Join 此表。
    - **維護成本**: 需同時維護主檔與對照表的一致性 (Consistency)，容易發生資料不同步。

### 方案 B：擴充 AD Schema (AD 屬性欄位)
直接在 Windows AD 的 User Object 中新增欄位 (Attribute) 存放舊 `USERID`。
- **優點**:
    - 真正的單一識別來源 (Identity Source)。
- **缺點**:
    - **實作風險高**: 需修改企業 AD Schema，通常涉及極高的權限與跨部門溝通，執行困難。
    - **依賴性**: 系統運作將過度依賴 AD，若需支援外部使用者 (無 AD 帳號) 則此路不通。

### 方案 C：整合於新使用者主檔 (USR Table) - [最終決策]
在新系統的 `USR` 表中直接設計欄位 (`AD_ACCOUNT`, `OLD_USERID`) 來儲存對應關係。
- **優點**:
    - **效能最佳**: 單一查詢即可取得所有識別資訊 (ID, AD, Old ID)。
    - **彈性高**: 可輕易支援混合模式 (同時容納 AD 帳號與 Local 帳號)。
    - **開發直觀**: 程式邏輯單純，無需處理多表同步。
- **缺點**:
    - 資料表欄位較多，需嚴謹定義欄位在不同帳號類型下的 `NULL` 規則。

**結論**: 採納 **方案 C**，以 `USR` 主檔作為身分轉換樞紐。

---

## 階段二：情境分析與對照策略

**時間點**: 探討新舊員工及離職情境
**關鍵議題**:
- **情境 A (新員工)**: AD 建立帳號，無舊 USERID。
- **情境 B (舊員工)**: 已有 AD 帳號及舊 USERID，需連結兩者。
- **情境 C (離職)**: AD 停用後，系統需同步停用，但歷史資料仍需可查。

**決策重點**:
- 確定不回寫舊系統 `USERS` 表，避免破壞舊系統邏輯。
- 確認需設計一個「身分轉換樞紐」機制，在登入時取得對應關係。

---

## 階段三：識別碼 (Primary Key) 設計演進

**時間點**: 資料庫結構設計 (PK 選擇)
**提案 1 (UUID/GUID)**:
- **建議**: 使用 `UserGUID` 作為新系統唯一鍵，避免與 AD 或舊 ID 格式衝突。
- **使用者反饋**: 擔憂 UUID 對資料庫效能 (索引破碎)、儲存空間及可讀性的負面影響。

**提案 2 (Snowflake ID) - 最終定案**:
- **修正建議**: 改用 **Snowflake ID (雪花演算法)**。
- **優勢**:
    1.  **有序性**: 時間排序，解決索引效能問題。
    2.  **效能**: `bigint` (64-bit) 比 UUID (128-bit) 更省空間且查詢更快。
    3.  **相容**: 作為內部代理鍵 (Surrogate Key)，外部可對應 AD 或舊 ID。

---

## 階段四：混合驗證模型 (Hybrid Authentication)

**時間點**: 考量外部使用者需求
**關鍵議題**:
- 系統不僅供內部員工 (AD) 使用，還有**外部客戶**與**系統帳號** (無 AD)。
- 需同時支援兩種驗證方式。

**決策重點**:
- 在 `USR` 主檔新增 `ACCOUNT_TYPE` 欄位區分來源：
    - `AD`: 內部員工，密碼由 AD 管理，`AD_ACCOUNT` 必填。
    - `LOCAL`: 外部/系統，密碼由系統管理 (Hash)，`LOCAL_ACCOUNT` 必填。
- 即使是 Local 帳號，PK 依然使用 Snowflake ID 統一管理。

---

## 階段五：權限與資料範圍 (RBAC & Scope)

**時間點**: 組織結構與多倉庫管理
**關鍵議題**:
- 倉儲部門組織複雜 (HQ、各倉、業務、客戶)。
- 權限不只是「功能」，還包含「資料範圍」 (如：只能看 A 倉庫的資料)。

**決策重點**:
- **角色 (ROL)**: 區分 `INTERNAL` (內部) 與 `EXTERNAL` (外部) 角色。
- **關聯 (URL)**: 在使用者與角色關聯時，加入 **資料範圍控制**：
    - `SCOPE_TYPE`: 定義範圍類型 (GLOBAL, WAREHOUSE, CUSTOMER)。
    - `SCOPE_VALUE`: 定義範圍值 (如 `WH_TP01`)。
- 此設計解決了「同一人在 A 倉是主管，在 B 倉無權限」的複雜矩陣需求。

---

## 階段六：登入邏輯與帳號衝突處理

**時間點**: 2025-11-30 異常情境討論
**關鍵議題**:
1.  **輸入介面**: 登入畫面是否需要讓使用者選擇「我是 AD」或「我是客戶」？
2.  **帳號衝突**: 若內部 AD 帳號 (`123.wilson`) 與舊有的外部客戶帳號 (`123.wilson`) 完全同名，系統如何區分？

**討論方案**:
- **方案 1 (自動判斷)**: 只有一個輸入框，後端自動查詢。
- **方案 1.5 (AD 優先 + 資料清洗)**: 同上，但遇到重名時強制視為 AD 帳號。

**決策結論 (策略 1.5)**:
1.  **統一入口**: 保持單一登入畫面，提升使用者體驗。
2.  **AD 絕對優先 (AD First)**: 若帳號同時存在於 `AD_ACCOUNT` 與 `LOCAL_ACCOUNT`，系統**強制執行 AD 驗證**。
3.  **重名衝突處理 (Data Cleansing)**:
    - 承認 AD 與舊系統帳號可能格式相同 (如 `123.wilson`)。
    - **決策**: 在資料移轉階段，針對與 AD 重名的極少數外部客戶帳號，**強制更名 (Rename)** (例如加上前綴 `ext.123.wilson`)，以確保全系統帳號唯一性。
    - 程式邏輯不需處理複雜的衝突判斷，而是依賴資料的乾淨度。

---

## 階段七：營運持續與災難復原 (BCP) - AD 連線中斷處理

**時間點**: 2025-11-30 異常情境討論
**關鍵議題**: 當企業 AD 服務全面中斷或網路斷線時，倉儲作業如何持續？

**討論方案與決策**:

採納 **「預防 + 緩衝 + 救援」** 三層防護網策略：

### 第一層：預防 (HA 架構)
- **現況**: 企業已具備多台 DC (Domain Controller) 與 RODC (Read-Only DC)。
- **決策**: 系統連線字串 (Connection String) 必須配置 Failover 機制，確保能自動切換至備援 DC，避免單點故障。

### 第二層：緩衝 (Refresh Token) - [待研議]
- **概念**: 利用長效 Refresh Token 機制，讓已登入的使用者在 AD 瞬斷期間仍可換發 Token 繼續作業。
- **狀態**: 需進一步評估資安風險 (如：離職員工恰逢 AD 斷線無法即時踢除) 與實作複雜度，暫列為保留項目。

### 第三層：救援 (緊急應變授權 Emergency Access) - [核心決策]
- **機制**: 當 AD 長時間無法恢復，需啟動緊急應變。
- **操作者**: 僅限 **`admin_local`** (最高權限系統管理員，不依賴 AD)。
- **功能**: **「批次緊急授權 (Batch Authorization)」**
    - **授權對象**: 支援多種粒度選擇 (單一帳號、特定部門、特定角色、或全系統)。
    - **授權方式**: 啟用「緊急登入模式」，系統暫時為選定對象寫入一組「臨時 Local 密碼」。
    - **時效控制 (Auto-expire)**: **設定授權時效 (e.g., 4小時)**。時效一到，系統**自動清除**這些帳號的臨時密碼，強制恢復為 AD 驗證模式。
- **優勢**: 兼顧作業持續性與資安管理，避免「臨時權限忘記關閉」的漏洞。

---

## 階段八：資料表共用策略 (新舊系統並存)

**時間點**: 2025-11-30 架構策略討論
**關鍵議題**:
因新舊系統需分階段上線且長期並存，是否直接在舊系統的 `USERS` 表上擴充新欄位，使其成為新系統的 `USR` 主檔？(Single Source of Truth)

**方案評估**:

### 選項 A：直接擴充舊 `USERS` 表 (原地升級)
- **概念**: 在舊 `USERS` 表新增 `USER_ID (bigint)`、`AD_ACCOUNT` 等新欄位。
- **優點**: 資料單一，無需同步。
- **缺點**:
    1.  **PK 衝突**: 舊 PK 是 `varchar`，新系統規範 PK 是 `Snowflake ID (bigint)`。若沿用舊表，新系統的關聯表 (`ROL`, `URL`, `UPF`) 需被迫改回 FK 指向 `varchar`，犧牲效能。
    2.  **命名風格混亂**: 舊欄位 (`user_no`) 與新欄位 (`AD_ACCOUNT`) 混雜，維護困難。
    3.  **穩定性風險**: 修改核心舊表 (Schema Change) 可能導致舊系統鎖死或錯誤。

### 選項 B：建立新 `USR` 表 + 雙向同步 (New Table with Sync) - [建議方案]
- **概念**: 保持新架構獨立，透過程式或 Trigger 進行資料同步。
- **優點**:
    1.  **架構潔癖**: 新系統可使用最佳實踐 (Snowflake ID)，不受舊包袱影響。
    2.  **風險隔離**: 不修改舊表結構，保障舊系統穩定。
- **缺點**: 需實作同步機制 (The Bridge)，處理資料一致性。

**目前狀態**: 針對此議題，我們記錄了兩者的利弊，待後續深入討論定案。

---
*此文件由 AI 專案顧問整理，旨在還原決策脈絡供後續參考。*
