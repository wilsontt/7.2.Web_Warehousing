# 📝 客戶資料維護與 IAM 身分識別整合：詳細設計與決策總結

**文件日期**：2025-12-05  
**適用範圍**：`@3.客戶資料維護`、`@1.身分識別與權限管理`  
**核心目標**：解決舊系統帳號雙邊維護痛點、落實異動強制稽核、整合 AD 身分驗證、確保歷史資料完整性。

---

## 1. 核心架構決策 (Core Decisions)

### 1.1 帳號生命週期管理 (Lifecycle Management)

**決策**：廢除「刪除帳號」功能，全面改採**「邏輯停用 (Soft Disable)」**。

**原因**：舊系統的物理刪除 (Physical Delete) 會導致歷史單據（如簽核紀錄）找不到關聯人名，造成稽核軌跡斷鏈。

**作法**：透過 `USR.STATUS = 0` (停用) 來阻斷登入，資料庫中保留該筆記錄。

### 1.2 維護流程整合 (Process Integration)

**決策**：實作**「單一入口服務 (One-Stop Service)」**。

**原因**：解決舊系統需分別在「Users」與「客戶聯絡人(CMP)」維護的重工與資料不一致風險。

**作法**：操作人員僅需在「客戶聯絡人」介面操作，後端系統自動同步處理 IAM (`USR`) 的帳號狀態。

### 1.3 身份驗證分流 (Auth Separation)

**決策**：嚴格區分**「內部員工 (AD)」**與**「外部客戶 (Local)」**的管理模式。

- **海灣內部員工**：帳號由 AD 託管，系統內**不需手動建立與維護**，禁止在系統內修改密碼。
- **外部客戶**：帳號由系統管理，需在系統內執行開通、停用、密碼重設。

---

## 2. 資料庫結構變更詳細規格 (Schema Changes)

為了支援上述決策，需針對資料表進行以下具體擴充：

### 2.1 `CMP` (客戶使用者主檔) - 擴充欄位

主要用於連結 IAM 帳號，並記錄「當前」的異動狀態。

| 欄位代號 | 欄位名稱 (英) | 型態 | 必填 | 說明與注意事項 |
| :--- | :--- | :--- | :--- | :--- |
| **CMP_UID** | `user_id` | `bigint` | 否 | **(關鍵)** FK 指向 `USR.USER_ID`。若為 NULL 代表尚未開通登入權限。 |
| **CMP30** | `status_change_reason` | `varchar(100)` | **是** | 記錄**最後一次**的異動原因 (如：離職、調動)。 |
| **CMP31** | `status_change_date` | `char(8)` | **是** | 記錄**最後一次**異動生效日期 (YYYYMMDD)。 |
| **CMP32** | `status_change_type` | `char(10)` | **是** | 異動類別：`DISABLE`(停用), `ENABLE`(復用), `TRANSFER`(調動)。 |

> **⚠️ 注意事項**：`CMP30`~`CMP32` 在前端介面上必須設為 **Required (必填)**，後端 API 亦需再次驗證，防止繞過。

### 2.2 `CMP_LOG` (客戶使用者異動歷程表) - **新資料表**

主要用於解決 `CMP` 只能記錄「最後一次」狀態，無法追溯完整歷史的問題。此表專注於 **業務面的原因記錄** (如：廠商倒閉、合約終止)。

| 欄位 | 中文說明 | 備註 |
| :--- | :--- | :--- |
| `id` | 流水號 | PK |
| `cmp_id` | 客戶使用者ID | FK 指向 CMP.id |
| `action_type` | 異動類別 | DISABLE, ENABLE, TRANSFER... |
| `reason` | **異動原因** | **(稽核重點)** 必須填寫具體原因。 |
| `effective_date` | **生效日期** | **(稽核重點)** |
| `created_by` | 經辦人 | 記錄執行此異動的操作者 (連結 USR.USER_ID)。 |
| `created_at` | 系統時間 | 自動寫入。 |

> **區隔說明**：系統底層另有 `UHT` (User History Trail) 負責記錄 `USR` 表的物理欄位變更 (Before/After)。`CMP_LOG` 專注於「業務理由」，`UHT` 專注於「系統狀態稽核」，兩者互補不衝突。

---

## 3. 關鍵情境處理邏輯 (Scenario Logic)

### 3.1 外部客戶：申請停用 (Disable Flow)

1. **使用者動作**：在客戶聯絡人介面點選「停用」，填寫「原因：離職」與「日期：2025/12/31」。
2. **系統檢核**：確認「原因」與「日期」有值，否則**拒絕存檔**。
3. **交易處理 (Transaction)**：
   - **Step A (業務層)**：更新 `CMP` 表 (`is_disabled='Y'`, 以及 CMP30~32 欄位)。
   - **Step B (歷程層)**：Insert 一筆記錄至 `CMP_LOG`。
   - **Step C (系統層)**：透過 `CMP.user_id` 找到 `USR` 資料，更新 `USR.STATUS = 0`。
4. **結果**：該帳號立即無法登入。

### 3.2 內部員工：新進與離職 (Internal AD Flow)

**新進 (Onboarding)**：
- **無需**在系統建立帳號。
- 員工使用 AD 帳號首次登入時，系統自動在 `USR` 表建立資料 (`ACCOUNT_TYPE='AD'`)。
- 系統管理員僅需事後指派「角色權限 (Role)」與「管轄倉庫 (Scope)」。

**離職 (Offboarding)**：
- **無需**在系統執行停用。
- 網管在 AD Server 停用帳號後，該員即刻無法通過驗證。
- (選用) 系統排程每日同步 AD 狀態，將已停用的 AD 帳號同步更新 `USR.STATUS=0` 以保持資料一致。

### 3.3 歷史資料遷移情境

**情境一：舊員工離職 (Legacy User - Disabled)**
- **狀況**：舊系統帳號 `abc` 已離職。
- **處理**：Migration 時，建立 `USR` 資料 (`ACCOUNT_TYPE='AD'`, `AD_ACCOUNT='abc'`, `OLD_USERID='abc'`)，並直接設定 **`STATUS=0` (停用)**。
- **結果**：無法登入，但歷史單據可正常顯示姓名。

**情境二：舊員工在職且已有 AD (Mapping)**
- **狀況**：舊帳號 `xyz`，AD 帳號 `xyz.123`。
- **處理**：Migration 時，透過對照表將 `AD_ACCOUNT='xyz.123'` 與 `OLD_USERID='xyz'` 寫入同一筆 `USR` 資料。
- **結果**：員工用 AD 帳號登入，且看得到舊帳號建立的歷史資料。

**情境三：比對不到帳號 (Orphan Data)**
- **狀況**：`CMP` 有聯絡人，但 `users` 表找不到人。
- **處理**：Migration 時，`CMP.user_id` 設為 `NULL`，列入異常清單。
- **補救**：若該員反應無法登入，管理者透過「補建帳號」功能修復。

---

## 4. 歷史資料遷移策略 (Migration Strategy)

針對舊系統轉新系統的過渡期，採取以下策略：

### 4.1 帳號關聯 (Mapping)

- **自動關聯**：利用舊系統 `users.userid` 與 `CMP.CMP00` (帳號) 字串一致的特性，Migration 程式自動比對並回填 `CMP.user_id`。
- **對照表 (Mapping Table)**：針對內部員工（舊帳號 `xyz` vs AD帳號 `xyz.123`），需準備 Excel 對照表，Migration 時將兩者寫入同一筆 `USR` 資料 (`AD_ACCOUNT` vs `OLD_USERID`)。

### 4.2 例外處理 (Exception Handling)

- **比對不到 (Orphans)**：若 `CMP` 有資料但 `users` 沒資料。
  - **處理**：`CMP.user_id` 設為 `NULL`。
  - **補救**：系統上線後，若該員反應無法登入，管理員透過「補建帳號」功能，當下建立 `USR` 並連結。

---

## 5. ⚠️ 重點注意事項 (Critical Attention Points)

此部分請在開發與測試階段特別留意：

### 5.1 強制原因檢核 (Mandatory Reason)

- 無論是前端 UI 或後端 API，對於「異動原因」欄位的檢查必須是 **強制性 (Strict)** 的。
- 不可接受空值、空白字元。
- 建議實作：前端表單驗證 + 後端 API 再次檢查，雙重防護。

### 5.2 業務單據的關聯欄位 (Reference ID)

- 新系統所有業務單據（進貨、出貨、庫存等）的 `created_by` / `updated_by`，**必須存 `bigint` (USR.USER_ID)**，絕對不可存 `varchar` (帳號或姓名)。
- **目的**：確保改名、改姓、或 AD 帳號變更時，歷史單據的關聯不會斷掉。

### 5.3 AD 帳號不可在系統改密碼

- 在「個人設定」或「忘記密碼」功能中，必須判斷 `ACCOUNT_TYPE`。
- 若為 `'AD'`，應隱藏修改密碼功能，或提示「請聯繫網管修改 Windows 密碼」。

### 5.4 歷史資料顯示 (Historical Data Display)

- 前端顯示「經辦人」時，應透過 `USR.USER_ID` 關聯取出 `USER_NAME`。
- 即便該 `USR.STATUS = 0` (已停用)，關聯查詢仍應能正常回傳姓名，不可顯示 "Unknown" 或空白。

### 5.5 單一入口服務的實作

- 所有客戶聯絡人的「新增、異動、停用、復用」操作，都必須透過統一的 Service Layer (`CustomerContactService`) 處理。
- 該 Service 必須確保 `CMP` (業務) 與 `USR` (系統) 的狀態永遠一致，使用 Transaction 確保原子性。

---

## 6. 待執行任務 (Action Items)

### 6.1 資料庫設計

- [x] 更新 `CMP` 資料表結構文件，新增 `CMP_UID`, `CMP30`, `CMP31`, `CMP32` 欄位定義。✅ 已完成 (2026-01-01)
- [x] 設計 `CMP_LOG` 資料表結構文件。✅ 已完成 (2026-01-01)
- [x] 確認 `USR` 資料表結構與欄位定義無誤。✅ 已確認
- [x] 建立 `UHT` 與 `RHT` 資料表，完善 IAM 稽核體系。✅ 已完成並補充完整 (2026-01-01)

### 6.2 API 規格設計

- [ ] 設計 `POST /api/contacts/{id}/status` 介面，規範異動原因的驗證邏輯。
- [ ] 設計 `GET /api/contacts/{id}/history` 介面，查詢異動歷程。
- [ ] 確認所有業務單據 API 的 `created_by` / `updated_by` 欄位型態為 `bigint`。

### 6.3 Migration 準備

- [ ] 準備 AD 帳號對照表 (Mapping Table) 格式範本。
- [ ] 撰寫 Migration Script，處理帳號自動關聯與例外清單產出。

### 6.4 前端介面設計

- [ ] 設計「客戶聯絡人異動」表單，確保「原因」與「日期」為必填。
- [ ] 設計「異動歷程查詢」頁面，顯示完整的異動記錄。
- [ ] 確認「個人設定」頁面針對 AD 帳號隱藏密碼修改功能。

---

## 7. 參考文件

- `0.standards/4.資料庫結構分析/1.基本作業/3.客戶資料維護/CMP_TABLE.md`
- `0.standards/4.資料庫結構分析/8.系統管理作業/1.身分識別與權限管理/USR_使用者主檔.md`
- `0.standards/4.資料庫結構分析/8.系統管理作業/1.身分識別與權限管理/0.身分識別與帳號整合策略.md`

---

**文件狀態**：✅ 已確認  
**最後更新**：2026-01-01
