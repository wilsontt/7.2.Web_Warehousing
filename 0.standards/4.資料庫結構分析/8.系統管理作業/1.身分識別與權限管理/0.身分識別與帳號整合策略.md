# 身分識別與帳號整合策略 (Identity & Account Integration Strategy)

**文件版本**: v1.2.0
**建立日期**: 2025-11-29
**狀態**: 已確認 (Confirmed)
**適用範圍**: 8.系統管理作業、登入驗證、全系統使用者關聯

---

## 1. 背景與目標

### 1.1 現況 (AS-IS)
- 舊系統使用自定義的 `USERID` (如 `001`, `wilson`) 作為使用者主鍵。
- 所有歷史業務資料皆透過 FK 關聯至此 `USERID`。
- 企業內部已全面導入 **Windows AD (Active Directory)**。
- 系統同時需服務「內部員工」與「外部客戶/系統帳號」。

### 1.2 目標 (TO-BE)
- **混合驗證 (Hybrid Auth)**: 支援 AD 帳號 (SSO) 與 本地帳號 (Local Auth) 並存。
- **歷史相容**: 完整保留舊系統歷史資料關聯。
- **架構現代化**: 採用 Snowflake ID 作為系統內部唯一識別。
- **細緻授權**: 實作基於角色 (Role) 與資料範圍 (Data Scope) 的雙重控管。

---

## 2. 關鍵挑戰與決策

### 2.1 挑戰
- **識別碼衝突**: AD 帳號、外部帳號與舊系統 ID 格式不一致。
- **多重身分源**: 需同時處理來自 AD 的同步資料與本地建立的外部帳號。
- **多維度權限**: 同一角色在不同倉庫或客戶間需有不同的存取權限。

### 2.2 架構決策：Snowflake ID + 混合帳號策略
系統將**不直接使用** AD 帳號或舊 ID 作為 PK，而是引入 Snowflake ID。

- **核心原則**:
    1.  **Snowflake ID 為主鍵**: 統一使用 64-bit 整數作為系統內部 ID。
    2.  **ACCOUNT_TYPE 區分**: 明確區分 `AD` (內部) 與 `LOCAL` (外部)。
    3.  **Mapping 為橋樑**: 記錄 AD 帳號、外部帳號與舊 ID 的對照關係。
    4.  **Scope 為邊界**: 權限必須綁定特定的資料範圍 (如倉庫 ID 或客戶 ID)。

---

## 3. 資料庫設計指引 (Schema Design)

### 3.1 USR - 使用者主檔 (核心識別)
| 欄位名稱 | 類型 | 用途與說明 |
| :--- | :--- | :--- |
| **USER_ID** | `bigint` | **PK (Snowflake ID)**。系統內部唯一識別碼。 |
| **ACCOUNT_TYPE** | `varchar` | `'AD'` (內部員工) / `'LOCAL'` (外部客戶/系統)。 |
| **DOMAIN_NAME** | `varchar` | AD 網域 (預留支援多網域，預設 `CORP`)。 |
| **AD_ACCOUNT** | `varchar` | AD 帳號 (當 Type='AD' 時必填)。 |
| **LOCAL_ACCOUNT** | `varchar` | 外部帳號 (當 Type='LOCAL' 時必填)。 |
| **PASSWORD_HASH** | `varchar` | **僅 Type='LOCAL' 時有值**。Type='AD' 時為 NULL。 |
| **OLD_USERID** | `varchar` | 舊系統 ID (歷史查詢用)。 |

### 3.2 ROL - 角色主檔 (功能定義)
| 欄位名稱 | 類型 | 用途與說明 |
| :--- | :--- | :--- |
| **ROLE_TYPE** | `varchar` | `'INTERNAL'` (內部員工用) / `'EXTERNAL'` (外部客戶用)。 |
| **IS_SYSTEM** | `bit` | 系統內建角色 (如 SUPER_ADMIN) 不可刪除。 |

### 3.3 URL - 使用者角色關聯 (授權與範圍)
| 欄位名稱 | 類型 | 用途與說明 |
| :--- | :--- | :--- |
| **SCOPE_TYPE** | `varchar` | 資料範圍類型：`GLOBAL` (全域), `WAREHOUSE` (倉庫), `CUSTOMER` (客戶)。 |
| **SCOPE_VALUE** | `varchar` | 資料範圍值：對應 `*`, `WH_ID`, `CUST_ID`。 |

---

## 4. 情境處理邏輯 (Scenario Handling)

### 🔴 情境 A：新進員工 (New Hire - AD)
1.  **帳號建立**: 網管建立 AD 帳號 -> 同步至 `USR` 表。
2.  **欄位設定**: `ACCOUNT_TYPE='AD'`, `AD_ACCOUNT='new.user'`, `PASSWORD_HASH=NULL`, `OLD_USERID=NULL`。
3.  **登入**: 使用 AD 帳號登入。

### 🔵 情境 B：既有員工 (Legacy User - AD)
1.  **資料移轉**: 匯入舊 `USERS` 表 -> 填入 `OLD_USERID`。
2.  **欄位設定**: `ACCOUNT_TYPE='AD'`, `AD_ACCOUNT='old.emp'`, `OLD_USERID='001'`。
3.  **歷史查詢**: 系統偵測到 `OLD_USERID`，查詢舊表時自動帶入。

### 🟢 情境 C：外部客戶 (External User - Local)
1.  **帳號建立**: 管理員在系統建立帳號。
2.  **欄位設定**: `ACCOUNT_TYPE='LOCAL'`, `LOCAL_ACCOUNT='cust01'`, `PASSWORD_HASH='...'`。
3.  **登入**: 系統比對 DB 密碼雜湊。

---

## 5. 授權與資料範圍策略 (Authorization & Data Scope)

### 5.1 雙重控管模型
本系統採用 **RBAC (角色)** + **Data Scope (資料範圍)** 的雙重控管模型。單純擁有「角色」並不足以操作資料，必須同時具備該資料所屬的「範圍」。

### 5.2 資料範圍 (Scope) 定義
在 `URL` (使用者角色關聯表) 中，每一筆授權都必須指定 Scope：

| Scope Type | Scope Value | 適用角色範例 | 權限邏輯 |
| :--- | :--- | :--- | :--- |
| **GLOBAL** | `*` | 總經理, 總稽核 | 可存取全系統資料。 |
| **WAREHOUSE** | `WH_01` (台北倉) | 倉庫經理, 理貨員 | 僅能存取 `WarehouseID = WH_01` 的單據與庫存。 |
| **CUSTOMER** | `CUST_001` (台積電) | 客戶經辦, 業務 | 僅能存取 `CustomerID = CUST_001` 的庫存與報表。 |

### 5.3 多重身分處理
若同一使用者需管理多個倉庫（例如：代理人）：
- 需在 `URL` 表中建立**多筆**記錄。
- 例：
    1. Role=`WH_MANAGER`, Scope=`WH_01` (本職)
    2. Role=`WH_MANAGER`, Scope=`WH_02` (代理)
- 登入後，系統將合併其所有 Scope，允許跨倉庫操作。

---

## 6. 待執行任務 (Action Items)

1.  [ ] **建立初始對照表**: 整理 AD 帳號與舊 UserID 對照清單。
2.  [ ] **設計資料表**: 產出 `USR`, `ROL`, `URL`, `FNC`, `RPM` 結構文件。
3.  [ ] **實作 Scope Filter**: 在後端 API 層 (Repository/Service) 實作通用的資料過濾攔截器 (Data Scope Interceptor)。
