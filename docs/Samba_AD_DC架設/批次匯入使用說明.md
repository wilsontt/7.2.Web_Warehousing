# Samba AD DC 批次匯入使用者與群組 - 使用說明

## 一、目的

提供標準化的 CSV 格式與批次匯入腳本，將使用者帳號與群組資料一次性匯入 Samba AD DC，用於開發環境的 IAM 整合測試。

## 二、檔案結構

```
docs/Samba_AD_DC架設/
├── import-users-groups.sh      # 批次匯入腳本
├── users-groups.csv            # 使用者與群組清單（CSV 格式）
├── users-groups-template.csv   # CSV 格式範本（可選）
└── 批次匯入使用說明.md         # 本文件
```

## 三、CSV 檔案格式規範

### 3.1 檔案編碼

- **必須使用 UTF-8 編碼**（支援中文）
- 建議使用 Excel 或文字編輯器（如 VS Code）編輯

### 3.2 欄位定義

| 欄位名稱 | 必填 | 說明 | 範例 |
|---------|------|------|------|
| 群組名稱 | 是 | AD 群組名稱（英文代碼） | HQ, KA, KB |
| 群組說明 | 是 | 群組中文說明 | HQ 總公司 |
| 帳號名稱 | 是 | AD 使用者帳號（英文） | Wu.Doris |
| 職務 | 是 | 使用者職務 | 業務行政助理 |
| EMAIL | 否 | 電子郵件地址（無則填 `-`） | doris@crownvan.com |
| 帳號說明 | 是 | 使用者顯示名稱（中文） | HQ 吳素芳 Wu.Doris |
| 備註 | 否 | 特殊標記（如「未進AD」） | 支援人員未進AD |

### 3.3 標題行格式

CSV 檔案第一行必須為標題行，格式如下：

```csv
群組名稱,群組說明,帳號名稱,職務,EMAIL,帳號說明,備註
```

### 3.4 特殊處理規則

1. **「未進AD」標記**：若「備註」欄位包含「未進AD」或「AD暫停用」，該筆記錄會被跳過，不會建立 AD 帳號。
2. **EMAIL 為空**：若 EMAIL 欄位為 `-` 或空白，系統會跳過 email 設定。
3. **重複帳號**：同一個帳號名稱出現在多個群組時，系統會自動去重，只建立一次帳號，但會將該帳號加入所有對應的群組。

## 四、使用方式

### 4.1 準備 CSV 檔案

1. 使用現有的 `users-groups.csv` 或建立新的 CSV 檔案
2. 依照格式填入使用者與群組資料
3. 確認檔案編碼為 UTF-8
4. 確認標題行格式正確

### 4.2 執行批次匯入

```bash
# 基本用法（使用預設密碼 TempPassword123!）
sudo ./import-users-groups.sh users-groups.csv

# 指定自訂密碼
sudo ./import-users-groups.sh users-groups.csv MyCustomPassword123!
```

### 4.3 執行流程

腳本會依序執行以下步驟：

1. **參數檢查**：確認 CSV 檔案存在且格式正確
2. **解析 CSV**：讀取並解析 CSV 檔案內容
3. **建立群組**：自動建立所有群組（去重）
4. **建立使用者**：自動建立所有使用者帳號（去重）
5. **加入群組**：將使用者加入對應的群組
6. **驗證結果**：顯示匯入統計與驗證結果

## 五、驗證與測試

### 5.1 驗證群組

```bash
# 列出所有群組
sudo samba-tool group list

# 查看特定群組的成員
sudo samba-tool group listmembers HQ
sudo samba-tool group listmembers KA
```

### 5.2 驗證使用者

```bash
# 列出所有使用者
sudo samba-tool user list

# 查看特定使用者的詳細資訊
sudo samba-tool user show Wu.Doris
sudo samba-tool user show Tzou.Wilson
```

### 5.3 測試 Kerberos 認證

```bash
# 測試使用者登入（使用預設密碼）
kinit Wu.Doris
# 輸入密碼: TempPassword123!
klist
```

## 六、常見問題

### Q1: CSV 檔案中文顯示亂碼？

**A**: 確認檔案編碼為 UTF-8。使用 `file -bi users-groups.csv` 檢查編碼，必要時使用 `iconv` 轉換。

### Q2: 腳本執行時出現「CSV 標題行不符合預期格式」？

**A**: 確認第一行標題為：`群組名稱,群組說明,帳號名稱,職務,EMAIL,帳號說明,備註`（不含空格）。

### Q3: 如何重新匯入（更新）帳號資料？

**A**: 直接修改 CSV 檔案後重新執行腳本。腳本會自動檢查帳號/群組是否已存在，已存在的會跳過，只建立新的。

### Q4: 如何刪除已匯入的帳號或群組？

**A**: 使用 samba-tool 手動刪除：

```bash
# 刪除使用者
sudo samba-tool user delete <username>

# 刪除群組
sudo samba-tool group delete <groupname>
```

### Q5: 如何批次修改使用者密碼？

**A**: 使用 samba-tool 手動修改，或修改腳本中的 `DEFAULT_PASSWORD` 變數後重新執行（但已存在的帳號不會更新密碼）。

## 七、注意事項

1. **預設密碼**：所有新建立的帳號使用統一預設密碼，**正式環境請提醒使用者首次登入後修改**。
2. **重複執行**：腳本可安全重複執行，已存在的帳號/群組不會重複建立。
3. **備份建議**：執行大量匯入前，建議先備份 Samba AD 資料庫。
4. **權限要求**：腳本必須以 `sudo` 執行，需要 root 權限。

## 八、參考文件

- `Ubuntu Server 上 Samba AD DC 架設紀錄.md` - Samba AD DC 安裝說明
- `install-samba-ad.sh` - Samba AD DC 安裝腳本
- `samba-ad-帳號_群組清單.md` - 原始帳號清單（Markdown 格式）

---

**文件版本**：v1.0  
**最後更新**：2025-12-05

