# 驗證腳本執行示範

## 執行方式

### 方式一：在 AD DC 伺服器本機執行（推薦）

```bash
cd docs/Samba_AD_DC架設/
sudo ./verify-ad-dc.sh
```

### 方式二：從其他機器遠端執行

```bash
cd docs/Samba_AD_DC架設/
sudo ./verify-ad-dc.sh 192.168.98.10
```

---

## 預期執行結果（成功範例）

```
==========================================
Samba AD DC 驗證腳本
==========================================
AD DC IP: 192.168.98.10
網域: lab1.wilsontt.com
Realm: LAB1.WILSONTT.COM
==========================================

[INFO] 1. 檢查 Samba AD DC 服務狀態...
✓ Samba AD DC 服務運行中
● samba-ad-dc.service - Samba Active Directory Domain Controller
     Loaded: loaded (/lib/systemd/system/samba-ad-dc.service; enabled; vendor preset: enabled)
     Active: active (running) since Mon 2025-12-30 11:00:00 CST; 1h 30m ago

[INFO] 2. 測試 DNS 功能...
✓ 主機 A 記錄查詢成功
dc1.lab1.wilsontt.com has address 192.168.98.10
✓ 網域 A 記錄查詢成功
lab1.wilsontt.com has address 192.168.98.10
✓ LDAP SRV 記錄查詢成功
_ldap._tcp.lab1.wilsontt.com has SRV record 0 100 389 dc1.lab1.wilsontt.com.
✓ Kerberos SRV 記錄查詢成功
_kerberos._tcp.lab1.wilsontt.com has SRV record 0 100 88 dc1.lab1.wilsontt.com.

[INFO] 3. 測試網路連線...
✓ LDAP port (389) 可連線
✓ Kerberos port (88) 可連線
✓ DNS port (53) 可連線

[INFO] 4. 測試 Kerberos 認證...
請輸入 Administrator 密碼進行 Kerberos 認證測試：
Password for Administrator@LAB1.WILSONTT.COM: 
✓ Kerberos 認證成功
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: Administrator@LAB1.WILSONTT.COM

[INFO] 5. 查詢使用者與群組...
✓ 找到 15 個使用者
使用者列表（前 5 個）：
  Administrator
  Guest
  krbtgt
  Wu.Doris
  Chen.Eileen
✓ 找到 8 個群組
群組列表（前 5 個）：
  Domain Admins
  Domain Users
  Domain Guests
  HQ
  KA

[INFO] 6. 測試 LDAP 查詢...
✓ LDAP 查詢成功

==========================================
[INFO] 驗證完成！
==========================================

如果所有項目都顯示 ✓，表示 AD DC 運作正常。
如有 ✗ 項目，請檢查對應的服務設定。

下一步：
  1. 執行批次匯入: sudo ./import-users-groups.sh users-groups.csv
  2. 設定 Windows 機器加入網域
```

---

## 實際執行示範

### 步驟 1: 檢查腳本權限

```bash
$ ls -lh docs/Samba_AD_DC架設/verify-ad-dc.sh
-rwxr-xr-x  1 user  staff  7.9K Dec 30 11:36 verify-ad-dc.sh
```

### 步驟 2: 執行驗證腳本

```bash
$ cd docs/Samba_AD_DC架設/
$ sudo ./verify-ad-dc.sh 192.168.98.10
```

**注意**：如果從本機執行但無法連線遠端，會看到：

```
[INFO] 1. 檢查 Samba AD DC 服務狀態...
✗ 無法連線到遠端 AD DC 或服務未運行
[WARN] 可能原因：
[WARN]   1. SSH 連線失敗（請確認 SSH 金鑰設定或密碼認證）
[WARN]   2. 服務未運行（請在 AD DC 上執行: sudo systemctl start samba-ad-dc）
[WARN]   3. 網路連線問題（請確認 IP 位址正確）
[WARN] 
[WARN] 建議：直接在 AD DC 伺服器上執行本腳本（不指定 IP）
```

### 步驟 3: 在 AD DC 伺服器上執行（正確方式）

```bash
# SSH 連線到 AD DC 伺服器
ssh user@192.168.98.10

# 上傳或複製驗證腳本到伺服器
# 然後執行：
sudo ./verify-ad-dc.sh
```

---

## 各項檢查說明

### ✓ 1. 服務狀態檢查

**檢查內容**：確認 `samba-ad-dc` 服務是否運行

**成功標誌**：顯示 `active (running)`

**失敗處理**：
```bash
sudo systemctl start samba-ad-dc
sudo systemctl enable samba-ad-dc
```

---

### ✓ 2. DNS 功能測試

**檢查內容**：
- 主機 A 記錄（dc1.lab1.wilsontt.com）
- 網域 A 記錄（lab1.wilsontt.com）
- LDAP SRV 記錄
- Kerberos SRV 記錄

**成功標誌**：所有查詢都能解析到正確的 IP 或服務

**失敗處理**：
```bash
# 檢查 DNS 設定
sudo samba-tool dns query localhost lab1.wilsontt.com @ ALL

# 檢查服務日誌
sudo journalctl -u samba-ad-dc -n 50
```

---

### ✓ 3. 網路連線測試

**檢查內容**：測試必要的網路 port 是否可連線
- LDAP: 389
- Kerberos: 88
- DNS: 53

**成功標誌**：所有 port 都可連線

**失敗處理**：
```bash
# 檢查防火牆
sudo ufw status
sudo iptables -L -n

# 檢查服務監聽狀態
sudo netstat -tuln | grep -E ':(389|88|53)'
```

---

### ✓ 4. Kerberos 認證測試

**檢查內容**：使用 Administrator 帳號測試 Kerberos 認證

**成功標誌**：能成功取得 Kerberos ticket

**失敗處理**：
```bash
# 檢查 Kerberos 設定
cat /etc/krb5.conf

# 查看詳細錯誤
kinit -V Administrator@LAB1.WILSONTT.COM
```

---

### ✓ 5. 使用者與群組查詢

**檢查內容**：查詢現有的使用者與群組

**成功標誌**：能列出使用者與群組列表

**失敗處理**：
```bash
# 檢查服務日誌
sudo journalctl -u samba-ad-dc -n 100

# 手動測試
sudo samba-tool user list
sudo samba-tool group list
```

---

### ✓ 6. LDAP 查詢測試

**檢查內容**：測試 LDAP 連線與查詢功能

**成功標誌**：能成功查詢 LDAP 資料

**失敗處理**：
```bash
# 安裝 ldap-utils（如果尚未安裝）
sudo apt install ldap-utils -y

# 測試 LDAP 連線
ldapsearch -x -H ldap://localhost -b "DC=lab1,DC=wilsontt,DC=com" -s base
```

---

## 常見執行問題

### 問題 1: 權限不足

**錯誤訊息**：
```
Permission denied
```

**解決方式**：
```bash
# 使用 sudo 執行
sudo ./verify-ad-dc.sh
```

---

### 問題 2: 腳本找不到

**錯誤訊息**：
```
bash: ./verify-ad-dc.sh: No such file or directory
```

**解決方式**：
```bash
# 確認當前目錄
pwd

# 進入正確目錄
cd docs/Samba_AD_DC架設/

# 確認檔案存在
ls -l verify-ad-dc.sh
```

---

### 問題 3: SSH 連線失敗（遠端驗證）

**錯誤訊息**：
```
ssh: connect to host 192.168.98.10 port 22: Connection refused
```

**解決方式**：
1. 確認 SSH 服務運行：`sudo systemctl status ssh`
2. 確認 IP 位址正確
3. 確認網路連線：`ping 192.168.98.10`
4. 建議直接在 AD DC 伺服器上執行（不指定 IP）

---

### 問題 4: 服務未運行

**錯誤訊息**：
```
✗ Samba AD DC 服務未運行
```

**解決方式**：
```bash
# 啟動服務
sudo systemctl start samba-ad-dc

# 設定開機自動啟動
sudo systemctl enable samba-ad-dc

# 檢查服務狀態
sudo systemctl status samba-ad-dc
```

---

## 驗證通過後的下一步

當所有檢查項目都顯示 ✓ 時，表示 AD DC 運作正常，可以進行：

1. **批次匯入使用者與群組**：
   ```bash
   sudo ./import-users-groups.sh users-groups.csv
   ```

2. **設定 Windows 機器加入網域**

3. **開始 IAM 整合開發測試**

---

**文件版本**：v1.0  
**最後更新**：2025-12-30

