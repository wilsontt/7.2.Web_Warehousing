# 身分識別與權限管理 (IAM) 畫面設計風險分析報告

## 1. 執行摘要 (Executive Summary)

針對在 **不考慮後端設計、中介 API 及連動關聯** 的前題下，單獨設計「1. 身分識別與權限管理」前端畫面的可行性評估。

**結論**: 此策略具有 **極高風險**。IAM (Identity and Access Management) 模組與資料結構 (Schema) 高度耦合，單純以前端視角 (UI First) 設計容易遺漏關鍵的資料邏輯，導致後續與後端整合時需要 **大幅重構 (Rework)** 甚至 **打掉重練**。

---

## 2. 關鍵風險分析 (Key Risk Analysis)

### 🔴 2.1 資料型別與精確度缺失 (The Snowflake ID Problem)
*   **背景**: 根據架構文件，`USER_ID` 與 `ROLE_ID` 採用 **Snowflake ID (64-bit integar)**。
*   **前端陷阱**: JavaScript 的 `Number` 型別最大僅支援 $2^{53}-1$ (安全整數)。
*   **設計後果**: 若前端畫面/Mock Data 直接使用數字 (e.g., `1234567890123456789`)，在瀏覽器端會發生**精確度遺失 (Precision Loss)**，導致 ID 末幾位變成 0，無法正確對應回後端資料。
*   **修正成本**: 高。所有涉及 ID 的 Props、Interface 與 API 呼叫皆需強制轉為 `string` 處理。

### 🔴 2.2 複雜的「資料範圍」關聯 (Complex Data Scope Association)
*   **背景**: 本系統採用 **RBAC + Data Scope**。使用者 (User) 與角色 (Role) 的關係並非一對一或一對多，而是含有 `Scope` (範圍) 的三元關聯 (`User` + `Role` + `Scope`)。
*   **前端陷阱**:
    *   **錯誤設計**: 常見設計為「使用者編輯頁面」下方有一個「勾選角色」的 Checkbox List。
    *   **實際需求**: 必須是 **「新增關聯」的動態清單**，每一列需選擇「角色」+「範圍類型 (全域/倉庫/客戶)」+「範圍值」。例如：
        *   `角色: 倉管員` + `範圍: 倉庫` + `值: 台北倉`
        *   `角色: 倉管員` + `範圍: 倉庫` + `值: 高雄倉`
*   **後果**: 傳統的「多選選單 (Multi-select)」UI 完全無法滿足此需求，UI 佈局需重新設計為 Master-Detail 或類似 Data Grid 的操作模式。

### 🔴 2.3 權限樹狀結構的維護 (Recursive Permission Tree)
*   **背景**: `FNC` (System Functions) 是無限層級的樹狀結構；`RPM` (Permissions) 是角色對功能點的授權。
*   **前端陷阱**:
    *   前端容易假設「選單即權限」。
    *   但系統設計包含 `ACTION` (按鈕級) 權限，這些在選單上看不到，但需在「角色權限設定」畫面中呈現。
*   **設計挑戰**:
    *   若無後端 API 遞迴展開樹狀結構，前端需自行處理 `Parent-Child` 關聯邏輯 (e.g., 勾選 Parent 是否自動勾選 Child? 取消 Child 是否變更 Parent 狀態?)。
    *   這些邏輯若寫死在前端，未來與後端邏輯不一致時會造成權限漏洞。

### 🔴 2.4 稽核與異動軌跡的遺失 (Audit Trail Blind Spots)
*   **背景**: 文件 `UHT`, `RHT` 強調需記錄「異動前」與「異動後」的值。
*   **前端陷阱**:
    *   前端 UI 通常只送出「最終結果 (Final State)」。
    *   若依賴前端產生 Diff (差異比對) 再傳給後端，極不可靠且易被竄改。
*   **後果**: UI 設計時若無考慮「檢視異動紀錄」的入口或流程，將導致此核心功能無處安放。

### 🔴 2.5 AD 與 Local 帳號的混和驗證 UI
*   **背景**: 系統支援 AD 與 Local 雙軌。
*   **前端陷阱**:
    *   **密碼修改**: AD 帳號**不可**在本系統修改密碼，Local 帳號**可以**。
    *   **UI 邏輯**: 若 UI 只有一套「修改密碼」按鈕，未根據 `ACCOUNT_TYPE` 動態顯示/隱藏，使用者會感到困惑 (為何點了沒反應？或為何改了沒用？)。

---

## 3. 畫面設計建議 (Recommended Screen Architecture)

建議將 IAM 模組拆解為以下獨立的 UI 流程，而非單一巨大的「管理畫面」：

| 畫面功能 | 關鍵 UI 特性與限制 |
| :--- | :--- |
| **使用者清單 (User List)** | 需呈現 `Account Type` (AD/Local) 標記；搜尋需支援模糊匹配。 |
| **使用者編輯 (User Editor)** | **基本資料**區塊需根據 AD/Local 鎖定唯讀欄位 (AD 同步欄位不可改)。 |
| **角色指派 (Role Assignment)** | **獨立的 UI 區塊**。不使用簡單 Dropdown，改用「關聯清單 (Association List)」，支援新增/刪除 `Role + Scope` 組合。 |
| **權限矩陣 (Permission Matrix)** | 左側為功能樹 (Tree)，右側為權限勾選 (Checkboxes)。需支援「全選/全不選」與「繼承」視覺回饋。 |
| **密碼變更 (Password Change)** | 僅對 Local 帳號開放。需包含舊密碼驗證、強度檢核 UI。 |

## 4. 總結

**「先畫 UI 再補邏輯」** 在 IAM 模組是行不通的。
建議先定義清晰的 **API Interface types (TypeScript Interfaces)**，模擬正確的資料結構 (包含 Snowflake ID string, Nested Objects)，再進行 UI Component 開發，否則高機率面臨翻修。
