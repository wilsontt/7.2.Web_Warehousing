# 規格文件 (SPEC): 1.1 代碼維護 (Code Maintenance)

**文件版本**: v1.1.0
**狀態**: 草稿 (Draft)
**建立日期**: 2025-11-28
**最近修訂**: 2025-11-28
**依據**:
- `0.standards/0.專案憲章-總規範-SDD工作流程/1.專案憲章 Project Constitution.md` (v2.2.0)
- `0.standards/0.專案憲章-總規範-SDD工作流程/2.文件倉儲管理系統 Warehouse Management System 設計規範v2.0.md`
- `0.standards/4.資料庫結構分析/1.代碼維護/CDF_代碼檔1_*.md`
- `0.standards/4.資料庫結構分析/1.代碼維護/CDS_代碼檔2_*.md`
- `0.standards/4.資料庫結構分析/1.代碼維護/CDT_代碼檔3_*.md`
- `0.standards/3.8大核心功能/1.基本作業/代碼維護/1.1.代碼維護.png` (舊系統參考畫面)

---

## 1. 目的 (Purpose)

本模組負責管理系統中所有「三層式階層代碼」的維護作業，取代舊系統的「代碼維護 (WD00000)」功能。此功能為「1. 基本作業」模組的核心子功能，提供管理員維護 **大分類 (CDF)**、**中分類 (CDS)**、**細分類 (CDT)** 的完整介面。

本規格特別強調**資料驅動 UI (Data-Driven UI)** 的設計理念，前端行為需嚴格遵循資料庫定義文件中的配置（如預設值、顯示格式、唯讀狀態）。

## 2. 範圍 (Scope)

**包含功能**:
- 三層式階層代碼 (Major/Mid/Sub) 的瀏覽與聯動過濾
- 大分類 (CDF)、中分類 (CDS)、細分類 (CDT) 的新增、修改、刪除
- **批次儲存機制**（遵循 **P8.3 明確的交易儲存**）
- 基於資料庫配置的前端驗證與顯示邏輯
- 複合主鍵驗證與級聯 (Cascading) 關聯檢查

**排除功能**:
- 代碼的啟用/停用狀態管理（本版本暫不實作，未來版本擴充）
- 代碼的歷史版本追蹤（非本階段需求）

---

## 3. 資料模型 (Data Model)

### 3.1 資料表關聯結構

本功能採用標準的 **Master-Detail-Detail** 三層架構：

```mermaid
erDiagram
    CDF ||--o{ CDS : "contains (1:N)"
    CDS ||--o{ CDT : "contains (1:N)"
    
    CDF { string CDF00 PK "大分類編碼" }
    CDS { string CDF00 FK, string CDS00 PK "中分類編碼" }
    CDT { string CDF00 FK, string CDS00 FK, string CDT00 PK "細分類編碼" }
```

**關聯規則**:
- **新增限制**: 必須先有大分類才能新增中分類；必須先有中分類才能新增細分類。
- **刪除限制**: 刪除大分類前必須清空其中分類；刪除中分類前必須清空其細分類。

### 3.2 前後端欄位映射與行為規範

> **[重要安全設計]** 依據 **P2 設計即安全** 原則，前端**禁止**直接使用資料庫欄位名稱。所有欄位必須使用「英文欄名 (Lovable)」進行映射。
> **[前端行為]** 前端元件、預設值與唯讀狀態**必須**遵循下表定義。

#### 3.2.1 CDF (大分類 - Major Category)

| 資料庫欄位 | 前端欄位名稱 (Lovable) | 中文名稱 | 必填 | 唯一 | 顯示格式/驗證規則 | 新增預設值 | 編輯狀態 (新/修) |
|:---|:---|:---|:---:|:---:|:---|:---|:---:|
| `CDF00` | `CategoryFirstNo` | 大分類編碼 | ✅ | ✅ | `char(3)` | - | ✅ / ❌ |
| `CDF01` | `MajorName` | 大分類名稱 | ✅ | ❌ | `varchar(120)` | - | ✅ / ✅ |
| `PageIndex` | `PageIndex` | 頁索引 | - | ❌ | `int` | - | ❌ / ❌ |
| `CRE_USERID` | `CreatedUserId` | 建檔人員 | - | ❌ | 顯示使用者名稱 | `Current User` | ❌ / ❌ |
| `CRE_DTIME` | `CreatedDateTime` | 建檔日期 | - | ❌ | `yyyy/MM/dd HH:mm:ss` | `Current Time` | ❌ / ❌ |
| `UPD_USERID` | `UpdatedUserId` | 修改人員 | - | ❌ | 顯示使用者名稱 | - | ❌ / ❌ |
| `UPD_DTIME` | `UpdatedDateTime` | 修改日期 | - | ❌ | `yyyy/MM/dd HH:mm:ss` | `Current Time` | ❌ / ❌ |
| `id` | `id` | 大分類序號 | - | ✅ | Hidden | Auto | ❌ / ❌ |
| `lock_version`| `LockVer` | 鎖定版本 | - | - | Hidden (樂觀鎖) | 0 | ❌ / ❌ |

#### 3.2.2 CDS (中分類 - Mid Category)

| 資料庫欄位 | 前端欄位名稱 (Lovable) | 中文名稱 | 必填 | 唯一 | 顯示格式/驗證規則 | 新增預設值 | 編輯狀態 (新/修) |
|:---|:---|:---|:---:|:---:|:---|:---|:---:|
| `CDF00` | `CategoryFirstNo` | 大分類編碼 | ✅ | ✅ | `char(3)` | (父層繼承) | ❌ / ❌ |
| `CDS00` | `CategorySecondNo` | 中分類編碼 | ✅ | ✅ | `char(3)` | - | ✅ / ❌ |
| `CDS01` | `MidName` | 編碼說明 | ✅ | ❌ | `varchar(120)` | - | ✅ / ✅ |
| `CDS02` | `Value1` | 數值1 | ❌ | ❌ | 千分位, 2位小數, 右靠 | 0 | ✅ / ✅ |
| `CDS03` | `Value2` | 數值2 | ❌ | ❌ | 千分位, 2位小數, 右靠 | 0 | ✅ / ✅ |
| `CDS04` | `Remark` | 備註 | ❌ | ❌ | `varchar(240)` | Empty | ✅ / ✅ |
| `CRE_USERID` | `CreatedUserId` | 建檔人員 | - | ❌ | 顯示使用者名稱 | `Current User` | ❌ / ❌ |
| `CRE_DTIME` | `CreatedDateTime` | 建檔日期 | - | ❌ | `yyyy/MM/dd HH:mm:ss` | `Current Time` | ❌ / ❌ |
| `UPD_USERID` | `UpdatedUserId` | 修改人員 | - | ❌ | 顯示使用者名稱 | - | ❌ / ❌ |
| `UPD_DTIME` | `UpdatedDateTime` | 修改日期 | - | ❌ | `yyyy/MM/dd HH:mm:ss` | `Current Time` | ❌ / ❌ |
| `id` | `id` | 中分類序號 | - | ✅ | Hidden | Auto | ❌ / ❌ |
| `cdf_id` | `CategoryFirstId` | 大分類ID | - | - | Hidden (FK) | (父層繼承) | ❌ / ❌ |

#### 3.2.3 CDT (細分類 - Sub Category)

| 資料庫欄位 | 前端欄位名稱 (Lovable) | 中文名稱 | 必填 | 唯一 | 顯示格式/驗證規則 | 新增預設值 | 編輯狀態 (新/修) |
|:---|:---|:---|:---:|:---:|:---|:---|:---:|
| `CDF00` | `CategoryFirstNo` | 大分類編碼 | ✅ | ✅ | `char(3)` | (父層繼承) | ❌ / ❌ |
| `CDS00` | `CategorySecondNo` | 中分類編碼 | ✅ | ✅ | `char(3)` | (父層繼承) | ❌ / ❌ |
| `CDT00` | `subcat_no` | 細分類編碼 | ✅ | ✅ | `char(3)` | - | ✅ / ❌ |
| `CDT01` | `code_desc` | 編碼說明 | ✅ | ❌ | `varchar(120)` | - | ✅ / ✅ |
| `CDT02` | `remark` | 備註 | ❌ | ❌ | `varchar(240)` | Empty | ✅ / ✅ |
| `CRE_USERID` | `CreatedUserId` | 建檔人員 | - | ❌ | 顯示使用者名稱 | `Current User` | ❌ / ❌ |
| `CRE_DTIME` | `CreatedDateTime` | 建檔日期 | - | ❌ | `yyyy/MM/dd HH:mm:ss` | `Current Time` | ❌ / ❌ |
| `UPD_USERID` | `UpdatedUserId` | 修改人員 | - | ❌ | 顯示使用者名稱 | - | ❌ / ❌ |
| `UPD_DTIME` | `UpdatedDateTime` | 修改日期 | - | ❌ | `yyyy/MM/dd HH:mm:ss` | `Current Time` | ❌ / ❌ |
| `id` | `id` | 細分類序號 | - | ✅ | Hidden | Auto | ❌ / ❌ |
| `cds_id` | `mid_cat_id` | 中分類ID | - | - | Hidden (FK) | (父層繼承) | ❌ / ❌ |

---

## 4. 使用者故事 (User Stories)

### US-1.1-001: 三層聯動瀏覽
**作為** 系統管理員
**我想要** 在一個畫面上同時看到「大分類」、「中分類」和「細分類」的列表，並透過點擊聯動過濾
**以便於** 快速瀏覽和維護三層之間的階層關聯性

**驗收條件**:
1.  **[UI 佈局]** 採用三欄式佈局（左：大分類 / 右上：中分類 / 右下：細分類），符合 `1.1.代碼維護.png` 參考畫面。
2.  **[聯動行為]**
    - 點擊「大分類」列 → 右上「中分類」列表刷新（僅顯示該大分類下的項目）。
    - 點擊「中分類」列 → 右下「細分類」列表刷新（僅顯示該中分類下的項目）。
    - 切換父層時，子層列表應先清空再載入。
3.  **[狀態提示]** 若未選擇父層，子層列表應顯示「請先選擇[父層名稱]」的提示訊息 (Empty State)。

### US-1.1-002: 批次資料維護 (CRUD)
**作為** 系統管理員
**我想要** 在三個列表中進行多次新增、修改、刪除操作，並在完成所有操作後，點擊「儲存」一次提交
**以便於** 確保資料一致性，並符合「明確的交易儲存」原則。

**驗收條件**:
1.  **[新增 - 預設值與繼承]**
    - 新增中分類時，系統自動將當前選定的大分類 `CategoryFirstNo` 填入並設為**唯讀**。
    - 新增細分類時，系統自動將當前選定的中分類 `CategoryFirstNo` 與 `CategorySecondNo` 填入並設為**唯讀**。
    - 建檔人員/時間欄位由前端暫填 `Current User/Time`，後端儲存時校正。
2.  **[修改 - 主鍵保護]**
    - 已存在的資料，其主鍵欄位 (`CategoryFirstNo`, `CategorySecondNo`, `subcat_no`) **禁止修改** (Disabled)。
    - 僅非主鍵欄位 (名稱、說明、數值、備註) 開放編輯。
3.  **[刪除 - 級聯防呆]**
    - 刪除大分類時，若其下仍有中分類，**禁止刪除**並提示「請先刪除所有的中分類」。
    - 刪除中分類時，若其下仍有細分類，**禁止刪除**並提示「請先刪除所有的細分類」。
4.  **[批次儲存]**
    - 按下「儲存」時，將所有變更打包為單一 Request。
    - 包含 `additions`, `updates`, `deletions` 三個陣列。
    - 後端需使用 Transaction 處理，失敗則全數 rollback。

### US-1.1-003: 資料驗證與完整性
**作為** 系統管理員
**我想要** 系統依照資料庫定義的規則進行驗證
**以便於** 防止錯誤格式或重複資料進入系統

**驗收條件**:
1.  **[必填驗證]** 依據 3.2 節定義，必填欄位為空時，輸入框顯示紅框並提示錯誤。
2.  **[格式驗證]**
    - `Value1`, `Value2`: 限制輸入數字，顯示時自動補 0 為兩位小數並加千分位 (e.g., `1,234.00`)。
    - 日期欄位: 顯示為 `yyyy/MM/dd HH:mm:ss`。
3.  **[唯一性驗證]**
    - 前端需檢查新增的代碼是否與列表中現有代碼重複（初步檢查）。
    - 後端 API 需捕捉 DB 的 Unique Constraint 錯誤並回傳友善訊息（e.g., 「大分類代碼 [001] 已存在」）。

---

## 5. 介面設計 (UI Design)

### 5.1 佈局結構
參考 `1.1.代碼維護.png`，B 區分為三塊：
- **Left Panel (25%)**: 大分類列表 (`CategoryFirstNo`, `MajorName`)
- **Right Top Panel (35%)**: 中分類列表 (`CategorySecondNo`, `MidName`, `Value1`, `Value2`)
- **Right Bottom Panel (40%)**: 細分類列表 (`subcat_no`, `code_desc`, `remark`)

### 5.2 工具列 (Toolbar)
位於 B 區頂部，包含：
- **Primary Actions**: `儲存` (Highlight when dirty), `取消`
- **CRUD Actions**: `新增大分類`, `新增中分類`, `新增細分類`, `刪除`
- **Utility**: `查詢`, `列印`

---

## 6. API 規格草案

### 6.1 批次儲存 API
- **Endpoint**: `POST /api/codemaintenance/batch`
- **Payload**:
  ```json
  {
    "cdf_changes": { "inserts": [], "updates": [], "deletes": [] },
    "cds_changes": { "inserts": [], "updates": [], "deletes": [] },
    "cdt_changes": { "inserts": [], "updates": [], "deletes": [] }
  }
  ```

---

## 7. 驗收標準 (Acceptance Criteria Summary)
- [ ] 所有欄位顯示名稱與格式符合 3.2 節定義。
- [ ] 三層聯動過濾運作正確，無殘留資料。
- [ ] 批次儲存功能正常，包含 Transaction 回滾測試。
- [ ] 數值欄位正確顯示千分位與小數位。
- [ ] 刪除防呆機制有效防止孤兒資料產生。
