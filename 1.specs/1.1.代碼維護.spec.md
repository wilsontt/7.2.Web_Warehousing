# 規格文件 (SPEC): 1.1 代碼維護 (Code Maintenance)

**文件版本**: v1.0.0  
**狀態**: 草稿 (Draft)  
**建立日期**: 2025-11-28  
**依據**:
- `0.standards/0.專案憲章-總規範-SDD工作流程/1.專案憲章 Project Constitution.md` (v2.2.0)
- `0.standards/0.專案憲章-總規範-SDD工作流程/2.文件倉儲管理系統 Warehouse Management System 設計規範v2.0.md`
- `0.standards/4.資料庫結構分析/1.代碼維護/CDF_代碼檔1_*.md`
- `0.standards/4.資料庫結構分析/1.代碼維護/CDS_代碼檔2_*.md`
- `0.standards/4.資料庫結構分析/1.代碼維護/CDT_代碼檔3_*.md`
- `0.standards/3.8大核心功能/1.基本作業/代碼維護/1.1.代碼維護.png` (舊系統參考畫面)

---

## 1. 目的 (Purpose)

本模組負責管理系統中所有「三層式階層代碼」的維護作業，取代舊系統的「代碼維護 (WD00000)」功能。此功能為「1. 基本作業」模組的核心子功能，提供管理員維護大分類 (CDF)、中分類 (CDS)、細分類 (CDT) 的完整介面。

## 2. 範圍 (Scope)

**包含功能**:
- 三層式階層代碼的瀏覽與聯動過濾
- 大分類 (CDF)、中分類 (CDS)、細分類 (CDT) 的新增、修改、刪除
- 批次儲存機制（遵循 **P8.3 明確的交易儲存**）
- 複合主鍵驗證與外鍵關聯檢查
- 資料完整性防呆機制

**排除功能**:
- 代碼的啟用/停用狀態管理（本版本暫不實作，未來版本擴充）
- 代碼的歷史版本追蹤（非本階段需求）

---

## 3. 資料模型 (Data Model)

### 3.1 資料表關聯

本功能涉及三個資料表，採用**三層式階層結構**：

```
CDF (代碼檔1 - 大分類)
 └─ CDS (代碼檔2 - 中分類)
     └─ CDT (代碼檔3 - 細分類)
```

**關聯規則**:
- CDS.CDF00 → CDF.CDF00 (Foreign Key)
- CDT.CDF00 + CDT.CDS00 → CDS.CDF00 + CDS.CDS00 (Composite Foreign Key)

### 3.2 前後端欄位映射規範

> **[重要安全設計]** 依據 **P2 設計即安全** 原則，前端**禁止**直接使用資料庫欄位名稱。所有欄位必須使用「英文欄名 (Lovable)」進行映射，避免洩漏資料庫結構。

#### CDF (大分類) 欄位映射

| 資料庫欄位 | 前端欄位名稱 (Lovable) | 中文名稱 | 資料型態 | 必填 | 唯一 | 說明 |
|-----------|---------------------|---------|---------|------|------|------|
| CDF00 | CategoryFirstNo | 大分類編碼 | char(3) | ✅ | ✅ | 主鍵，不可修改 |
| CDF01 | CategoryFirstName | 大分類名稱 | varchar(120) | ✅ | ❌ | |
| CRE_USERID | CreatedBy | 建檔人員 | varchar(10) | - | ❌ | 系統自動填入 |
| CRE_DTIME | CreatedAt | 建檔日期 | char(14) | - | ❌ | 格式: yyyyMMddHHmmss |
| UPD_USERID | UpdatedBy | 修改人員 | varchar(10) | - | ❌ | 系統自動填入 |
| UPD_DTIME | UpdatedAt | 修改日期 | char(14) | - | ❌ | 格式: yyyyMMddHHmmss |
| id | Id | 大分類序號 | bigint | - | ❌ | 自動遞增 (Identity) |

#### CDS (中分類) 欄位映射

| 資料庫欄位 | 前端欄位名稱 (Lovable) | 中文名稱 | 資料型態 | 必填 | 唯一 | 說明 |
|-----------|---------------------|---------|---------|------|------|------|
| CDF00 | CategoryFirstNo | 大分類編碼 | char(3) | ✅ | ✅ | 複合主鍵1，外鍵 |
| CDS00 | CategorySecondCode | 中分類編碼 | char(3) | ✅ | ✅ | 複合主鍵2 |
| CDS01 | CodeDescription | 編碼說明 | varchar(120) | ✅ | ❌ | |
| CDS02 | NumericValue1 | 數值1 | float | ❌ | ❌ | 千分位顯示，兩位小數 |
| CDS03 | NumericValue2 | 數值2 | float | ❌ | ❌ | 千分位顯示，兩位小數 |
| CDS04 | Remarks | 備註 | varchar(240) | ❌ | ❌ | |
| CRE_USERID | CreatedBy | 建檔人員 | varchar(10) | - | ❌ | 系統自動填入 |
| CRE_DTIME | CreatedAt | 建檔日期 | char(14) | - | ❌ | |
| UPD_USERID | UpdatedBy | 修改人員 | varchar(10) | - | ❌ | |
| UPD_DTIME | UpdatedAt | 修改日期 | char(14) | - | ❌ | |
| id | Id | 中分類序號 | bigint | - | ❌ | 自動遞增 (Identity) |
| cdf_id | CategoryFirstId | 大分類序號 | bigint | - | ❌ | 外鍵關聯 CDF.id |

#### CDT (細分類) 欄位映射

| 資料庫欄位 | 前端欄位名稱 (Lovable) | 中文名稱 | 資料型態 | 必填 | 唯一 | 說明 |
|-----------|---------------------|---------|---------|------|------|------|
| CDF00 | CategoryFirstNo | 大分類編碼 | char(3) | ✅ | ✅ | 複合主鍵1 |
| CDS00 | CategorySecondCode | 中分類編碼 | char(3) | ✅ | ✅ | 複合主鍵2 |
| CDT00 | CategoryThirdCode | 細分類編碼 | char(3) | ✅ | ✅ | 複合主鍵3 |
| CDT01 | CodeDescription | 編碼說明 | varchar(120) | ✅ | ❌ | |
| CDT02 | Remarks | 備註 | varchar(240) | ❌ | ❌ | |
| CRE_USERID | CreatedBy | 建檔人員 | varchar(10) | - | ❌ | |
| CRE_DTIME | CreatedAt | 建檔日期 | char(14) | - | ❌ | |
| UPD_USERID | UpdatedBy | 修改人員 | varchar(10) | - | ❌ | |
| UPD_DTIME | UpdatedAt | 修改日期 | char(14) | - | ❌ | |
| id | Id | 細分類序號 | bigint | - | ❌ | 自動遞增 (Identity) |
| cds_id | CategorySecondId | 中分類序號 | bigint | - | ❌ | 外鍵關聯 CDS.id |

---

## 4. 使用者故事 (User Stories)

### US-1.1-001: 三層聯動瀏覽

**作為** 系統管理員  
**我想要** 在一個畫面上同時看到「大分類」、「中分類」和「細分類」的列表，並透過點擊聯動過濾  
**以便於** 快速瀏覽和維護三層之間的階層關聯性

**驗收條件 (Acceptance Criteria)** - [**P3 清晰與可測試性**, **P8 一致的使用者體驗**]:

1. **[UI 佈局]** 介面**必須**採用三欄佈局：
   - 左側欄：大分類列表
   - 右上欄：中分類列表
   - 右下欄：細分類列表

2. **[UI 佈局]** 介面**必須**遵循 `設計規範v2.0.md` 的 A/B 區框架，本功能位於 B 區。

3. **[工具列]** B 區頂部工具列 (B2-1) 需提供以下按鈕：
   - 新增大分類
   - 新增中分類
   - 新增細分類
   - 刪除
   - 查詢
   - 列印
   - **儲存** (Primary Button，有變更時高亮)
   - **取消** (有變更時高亮)

4. **[聯動邏輯 - 大分類]** 點擊大分類列表中的任一項目時：
   - 中分類列表**必須**自動過濾，僅顯示該大分類下的資料
   - 細分類列表**必須**被清空，並顯示提示「請先選擇中分類」

5. **[聯動邏輯 - 中分類]** 點擊中分類列表中的任一項目時：
   - 細分類列表**必須**自動過濾，僅顯示該中分類下的資料

6. **[視覺回饋]** 被選中的大分類和中分類項目**必須**明確高亮顯示。

7. **[表格樣式]** 每個列表均需符合以下 UI 規範：
   - 隔行變色
   - 選取高亮
   - 內容過長時不自動折行 (`whitespace-nowrap`)

8. **[未儲存警告]** 當使用者切換大分類或中分類時，若當前有未儲存的變更，**必須**彈窗提示：「您有未儲存的變更，是否要放棄？」，使用者確認後才可切換。

---

### US-1.1-002: 批次資料維護 (CRUD)

**作為** 系統管理員  
**我想要** 在三個列表中進行多次新增、修改、刪除操作，並在完成所有操作後，點擊「儲存」一次提交  
**以便於** 確保所有相關變更被一次性處理，並有機會在儲存前「取消」

**驗收條件 (Acceptance Criteria)** - [**P2 設計即安全**, **P3 清晰與可測試性**, **P8.3 明確的交易儲存**]:

#### 新增操作

1. **[新增大分類]** 點擊「新增大分類」時：
   - 大分類列表應在**前端**新增一筆空白資料列
   - 該列應標記為「待新增」狀態（例如：背景淡黃色）
   - `CategoryFirstNo` 欄位為可編輯狀態
   - `CreatedBy` 和 `CreatedAt` 由系統自動填入（使用者不可見）

2. **[新增中分類]** 點擊「新增中分類」時：
   - **必須**檢查是否已選定一筆「大分類」
   - 若未選定，顯示提示：「請先選擇一個大分類」
   - 若已選定，中分類列表應新增一筆空白資料列
   - `CategoryFirstNo` 自動代入所選大分類的編碼，且為**唯讀**
   - 該列應標記為「待新增」狀態

3. **[新增細分類]** 點擊「新增細分類」時：
   - **必須**檢查是否已選定一筆「中分類」
   - 若未選定，顯示提示：「請先選擇一個中分類」
   - 若已選定，細分類列表應新增一筆空白資料列
   - `CategoryFirstNo` 和 `CategorySecondCode` 自動代入，且為**唯讀**
   - 該列應標記為「待新增」狀態

#### 修改操作

4. **[行內編輯]** 使用者應可**直接在列表的儲存格 (Cell) 中**點擊進行編輯。

5. **[修改標記]** 被修改的資料列應在**前端**標記為「待修改」狀態（例如：列前方顯示鉛筆圖示）。

6. **[主鍵保護]** 以下欄位在建立後**不允許**被修改：
   - `CategoryFirstNo`（大分類編碼）
   - `CategorySecondCode`（中分類編碼）
   - `CategoryThirdCode`（細分類編碼）

#### 刪除操作

7. **[刪除確認]** 點擊「刪除」按鈕時，**必須**彈窗二次確認：「確定要刪除所選資料嗎？」。

8. **[刪除標記]** 確認後，該資料列應在**前端**標記為「待刪除」狀態（例如：顯示刪除線或背景淡紅色）。

9. **[刪除防呆]** 系統**必須**有防呆機制：
   - 若大分類底下仍有中分類，則**禁止**刪除該大分類，顯示提示：「此大分類下仍有中分類，無法刪除」
   - 若中分類底下仍有細分類，則**禁止**刪除該中分類，顯示提示：「此中分類下仍有細分類，無法刪除」

#### 儲存與取消

10. **[批次儲存 - 核心]** 當使用者按下「儲存」按鈕時：
    - 系統**必須**收集所有被標記為「待新增」、「待修改」、「待刪除」的資料
    - **打包成一個批次請求 (Batch Request)**，統一提交至後端 API
    - 後端 API **必須**在一個資料庫「交易 (Transaction)」中處理此批次請求
    - 若任一筆資料驗證失敗，**整個交易回滾**，並回傳詳細錯誤訊息

11. **[儲存成功回饋]** 儲存成功後：
    - 前端列表應刷新，移除所有「待處理」狀態
    - 顯示成功訊息：「儲存成功」

12. **[取消確認]** 當使用者按下「取消」按鈕時，**必須**彈窗二次確認：「您確定要放棄所有未儲存的變更嗎？」。

13. **[取消行為]** 確認後，前端**必須**重新從後端載入資料，丟棄所有本地的變更。

---

### US-1.1-003: 資料驗證與完整性

**作為** 系統管理員  
**我想要** 系統在儲存前自動檢查資料的完整性與唯一性  
**以便於** 避免產生重複或不合法的代碼資料

**驗收條件 (Acceptance Criteria)** - [**P2 設計即安全**, **P3 清晰與可測試性**]:

1. **[必填驗證]** 以下欄位為**必填**，若未填寫，儲存時**必須**顯示錯誤訊息：
   - CDF: `CategoryFirstNo`, `CategoryFirstName`
   - CDS: `CategoryFirstNo`, `CategorySecondCode`, `CodeDescription`
   - CDT: `CategoryFirstNo`, `CategorySecondCode`, `CategoryThirdCode`, `CodeDescription`

2. **[唯一性驗證 - CDF]** `CategoryFirstNo`（大分類編碼）**必須**在 CDF 表中唯一。
   - 若重複，顯示：「大分類編碼已存在，請使用其他編碼」

3. **[唯一性驗證 - CDS]** `CategoryFirstNo` + `CategorySecondCode` 的組合**必須**在 CDS 表中唯一。
   - 若重複，顯示：「此大分類下已存在相同的中分類編碼」

4. **[唯一性驗證 - CDT]** `CategoryFirstNo` + `CategorySecondCode` + `CategoryThirdCode` 的組合**必須**在 CDT 表中唯一。
   - 若重複，顯示：「此中分類下已存在相同的細分類編碼」

5. **[外鍵驗證]** 新增中分類時，`CategoryFirstNo` 必須存在於 CDF 表中。
   - 新增細分類時，`CategoryFirstNo` + `CategorySecondCode` 必須存在於 CDS 表中。

6. **[數值格式驗證]** CDS 的 `NumericValue1` 和 `NumericValue2` 欄位：
   - 必須 >= 0
   - 允許小數位兩位
   - 顯示時採千分位格式（例如：1,234.56）

7. **[日期時間驗證]** `CreatedAt` 和 `UpdatedAt` 欄位：
   - 儲存格式：`yyyyMMddHHmmss`（14位字串）
   - 顯示格式：`yyyy/MM/dd HH:mm:ss`

---

## 5. 非功能性需求 (Non-Functional Requirements)

### NFR-1.1-001: 安全性 (Security) - [**P2 設計即安全**]

1. **[欄位映射]** 前端**禁止**直接使用資料庫欄位名稱（如 `CDF00`），**必須**使用「英文欄名 (Lovable)」（如 `CategoryFirstNo`）。

2. **[API 安全]** 所有 API 請求**必須**包含身份驗證 Token。

3. **[權限控制]** 僅具有「系統管理員」或「代碼維護」權限的使用者可存取本功能。

4. **[稽核日誌]** 所有新增、修改、刪除操作**必須**記錄於稽核日誌 (Audit Log) 中，包含：
   - 操作人員 (`UpdatedBy`)
   - 操作時間 (`UpdatedAt`)
   - 操作類型（新增/修改/刪除）
   - 變更前後的資料快照

### NFR-1.1-002: 使用者體驗 (UX) - [**P8 一致的使用者體驗**]

1. **[響應式設計]** 介面需在桌面、平板上皆能正常顯示與操作（手機端暫不支援此複雜功能）。

2. **[載入指示]** 當執行儲存或載入資料時，**必須**顯示載入指示器 (Loading Spinner)。

3. **[錯誤提示]** 所有錯誤訊息**必須**清楚指出問題欄位與錯誤原因。

### NFR-1.1-003: 效能 (Performance) - [**P9 效能要求**]

1. **[載入時間]** 初次載入大分類列表（假設 100 筆資料）的時間應 < 1 秒。

2. **[過濾效能]** 點擊大分類後，中分類列表的過濾與顯示應 < 300ms。

3. **[批次儲存]** 批次儲存（假設 20 筆變更）的回應時間應 < 3 秒。

---

## 6. 介面設計 (UI Design)

### 6.1 整體佈局

參考 `1.1.代碼維護.png` 舊系統畫面，採用**現代化三欄聯動設計**：

```
┌──────────────────────────────────────────────────────────────┐
│ A 區 - Header (導覽列)                                        │
├──────────────────────────────────────────────────────────────┤
│ B 區 - 主要內容區                                              │
│ ┌──────────────────────────────────────────────────────────┐ │
│ │ B2-1 麵包屑 + 工具列                                       │ │
│ │ 【首頁 > 基本作業 > 代碼維護】        [新增大分類] [新增中分類] │ │
│ │                                      [新增細分類] [刪除]   │ │
│ │                                      [查詢] [列印]        │ │
│ │                                      [儲存] [取消]        │ │
│ └──────────────────────────────────────────────────────────┘ │
│ ┌──────────┬───────────────────────────────────────────────┐ │
│ │ 大分類列表 │ 中分類列表                                     │ │
│ │          │                                               │ │
│ │ (左側欄)  │ (右上欄)                                       │ │
│ │          ├───────────────────────────────────────────────┤ │
│ │          │ 細分類列表                                      │ │
│ │          │                                               │ │
│ │          │ (右下欄)                                       │ │
│ └──────────┴───────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

**佈局說明**:

**B2-1 區域** (Flex 佈局):
- **左側**：麵包屑導覽（`justify-start`）
  - 格式：`首頁 > 基本作業 > 代碼維護`
  - 點擊可快速返回上層功能

- **右側**：操作工具列（`justify-end`）
  - 按鈕群組：新增/刪除/查詢/列印
  - 主要操作：**儲存**（Primary Button）、**取消**
  - 當有未儲存變更時，儲存/取消按鈕高亮

### 6.2 表格欄位顯示

#### 大分類列表 (CDF)

| 欄位名稱 | 顯示名稱 | 寬度 | 對齊 | 可編輯 |
|---------|---------|------|------|--------|
| CategoryFirstNo | 大分類編碼 | 100px | 左 | ✅ (新增時) |
| CategoryFirstName | 大分類名稱 | 250px | 左 | ✅ |

#### 中分類列表 (CDS)

| 欄位名稱 | 顯示名稱 | 寬度 | 對齊 | 可編輯 |
|---------|---------|------|------|--------|
| CategorySecondCode | 中分類編碼 | 100px | 左 | ✅ (新增時) |
| CodeDescription | 編碼說明 | 200px | 左 | ✅ |
| NumericValue1 | 數值1 | 120px | 右 | ✅ |
| NumericValue2 | 數值2 | 120px | 右 | ✅ |
| Remarks | 備註 | 200px | 左 | ✅ |

#### 細分類列表 (CDT)

| 欄位名稱 | 顯示名稱 | 寬度 | 對齊 | 可編輯 |
|---------|---------|------|------|--------|
| CategoryThirdCode | 細分類編碼 | 100px | 左 | ✅ (新增時) |
| CodeDescription | 編碼說明 | 250px | 左 | ✅ |
| Remarks | 備註 | 250px | 左 | ✅ |

---

## 7. API 規格 (API Specification)

### 7.1 取得大分類列表

```
GET /api/categories/major
Authorization: Bearer {token}
```

**回應範例** (使用前端欄位名稱):
```json
{
  "data": [
    {
      "CategoryFirstNo": "001",
      "CategoryFirstName": "物料類",
      "CreatedBy": "admin",
      "CreatedAt": "20251128143000",
      "UpdatedBy": "",
      "UpdatedAt": "",
      "Id": 1
    }
  ]
}
```

### 7.2 取得中分類列表

```
GET /api/categories/mid?categoryFirstNo=001
Authorization: Bearer {token}
```

### 7.3 取得細分類列表

```
GET /api/categories/sub?categoryFirstNo=001&categorySecondCode=001
Authorization: Bearer {token}
```

### 7.4 批次儲存

```
POST /api/categories/batch
Authorization: Bearer {token}
Content-Type: application/json

{
  "additions": [
    {
      "type": "major",
      "data": { "CategoryFirstNo": "002", "CategoryFirstName": "客戶類" }
    }
  ],
  "updates": [
    {
      "type": "mid",
      "id": 5,
      "data": { "CodeDescription": "更新後的說明" }
    }
  ],
  "deletions": [
    {
      "type": "sub",
      "id": 10
    }
  ]
}
```

**成功回應**:
```json
{
  "success": true,
  "message": "儲存成功",
  "affectedRows": 3
}
```

**失敗回應**:
```json
{
  "success": false,
  "message": "儲存失敗",
  "errors": [
    {
      "field": "CategoryFirstNo",
      "message": "大分類編碼已存在"
    }
  ]
}
```

---

## 8. 驗收標準 (Acceptance Criteria Summary)

所有使用者故事的驗收條件皆需通過，包含：

- [ ] US-1.1-001: 三層聯動瀏覽（8項驗收條件）
- [ ] US-1.1-002: 批次資料維護（13項驗收條件）
- [ ] US-1.1-003: 資料驗證與完整性（7項驗收條件）
- [ ] NFR-1.1-001: 安全性（4項）
- [ ] NFR-1.1-002: 使用者體驗（3項）
- [ ] NFR-1.1-003: 效能（3項）

---

**本規格文件版本**: v1.0.0  
**建立日期**: 2025-11-28  
**建立者**: AI 專案顧問 (Gemini)
